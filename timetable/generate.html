<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MScSimEd | Timetable Generator</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="../../auth.js"></script>
  <style>
    .first-teaching-date-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      cursor: pointer;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }

    .section-header:hover {
      background: var(--hover-bg);
    }

    .section-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.2rem;
    }

    .toggle-icon {
      color: var(--text-secondary);
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }

    .section-content {
      padding: 20px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    .section-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .first-teaching-date-section .form-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: end;
    }

    .first-teaching-date-section label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .first-teaching-date-section input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .first-teaching-date-section input[type="date"]:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    .calculate-dates-btn {
      background: var(--button-primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .calculate-dates-btn:hover {
      background: var(--button-primary-hover);
      transform: translateY(-1px);
    }

    .display-field {
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      color: var(--text-secondary);
      font-size: 1rem;
      min-height: 20px;
      display: flex;
      align-items: center;
    }

    @media (max-width: 768px) {
      .first-teaching-date-section .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .calculate-dates-btn {
        width: 100%;
      }
    }

    /* JSON Import Section Styles */
    .json-import-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      overflow: hidden;
    }

    .import-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: var(--card-bg);
      color: var(--text-primary);
      border-bottom-color: var(--button-primary);
    }

    .tab-content {
      display: none;
      padding: 0 20px 20px;
    }

    .tab-content.active {
      display: block;
    }

    .json-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 12px;
    }

    .json-textarea:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    .text-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .import-btn, .clear-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .import-btn {
      background: var(--button-primary);
      color: white;
    }

    .import-btn:hover:not(:disabled) {
      background: var(--button-primary-hover);
      transform: translateY(-1px);
    }

    .import-btn:disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
    }

    .clear-btn {
      background: #dc3545;
      color: white;
    }

    .clear-btn:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-1px);
    }

    .clear-btn:disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
    }

    .file-upload-area {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .file-select-btn {
      padding: 10px 16px;
      background: var(--button-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-select-btn:hover {
      background: var(--button-secondary-hover);
      transform: translateY(-1px);
    }

    .selected-file {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Cohort Modal Styles */
    .cohort-options {
      display: flex;
      gap: 16px;
      margin: 20px 0;
      justify-content: center;
    }

    .cohort-btn {
      padding: 16px 24px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 160px;
    }

    .cohort-btn:hover {
      background: var(--button-primary);
      color: white;
      border-color: var(--button-primary);
      transform: translateY(-2px);
    }

    .cohort-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#moduleDetails" class="skip-link">Skip to main content</a>
  
  <!-- Navbar -->
  <nav class="main-navbar" role="navigation" aria-label="Main navigation">
          <div class="navbar-title">
        <a href="../index.html" style="text-decoration: none; color: inherit;" aria-label="MScSimEd Home">
          <div class="title-main">ü§ñ MScSimEd</div>
        </a>
        <span class="title-separator">|</span>
        <div class="title-subtitle">üéØ Generate</div>
      </div>
      <div class="navbar-links">
        <div class="dropdown">
          <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false">üìÖ Timetable</button>
          <div class="dropdown-content" role="menu">
            <a href="generate.html" role="menuitem">üéØ Generate</a>
            <a href="preset/new.html" role="menuitem">üìÑ New Preset</a>
            <a href="preset/edit.html" role="menuitem">‚úèÔ∏è Edit Preset</a>
          </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
      </div>
  </nav>

  <!-- Preset Buttons -->
  <div class="preset-container" role="group" aria-label="Module presets">
    <button class="preset-btn" onclick="loadPreset('ED70011X')" aria-label="Load Foundations of Simulation Education preset">
      <strong>Foundations of Simulation Education</strong>
      <span class="module-code">ED70011X</span>
      <span class="year-tag year-1">Year 1</span>
    </button>

    <button class="preset-btn" onclick="loadPreset('ED70012X')" disabled aria-label="Simulation Delivery & Leadership preset (not available)">
      <strong>Simulation Delivery & Leadership</strong>
      <span class="module-code">ED70012X</span>
      <span class="year-tag year-1">Year 1</span>
    </button>

    <button class="preset-btn" onclick="loadPreset('ED70013X')" aria-label="Load Digital Technologies in Education preset">
      <strong>Digital Technologies in Education</strong>
      <span class="module-code">ED70013X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>

    <button class="preset-btn" onclick="loadPreset('ED70014X')" disabled aria-label="Current Issues & Policies in Simulation Education preset (not available)">
      <strong>Current Issues & Policies in Simulation Education</strong>
      <span class="module-code">ED70014X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>

    <button class="preset-btn" onclick="loadPreset('ED70015X')" disabled aria-label="Simulation in Innovative Practice preset (not available)">
      <strong>Simulation in Innovative Practice</strong>
      <span class="module-code">ED70015X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>

    <button class="preset-btn" onclick="loadPreset('ED70016X')" disabled aria-label="Quality Improvement & Demonstrative Simulation preset (not available)">
      <strong>Quality Improvement & Demonstrative Simulation</strong>
      <span class="module-code">ED70016X</span>
      <span class="year-tag year-3">Year 3</span>
    </button>
  </div>

  <!-- JSON Import Section -->
  <div class="json-import-section">
    <div class="section-header" onclick="toggleJsonImport()">
      <h3>üìÑ Import Custom JSON</h3>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="section-content" id="jsonImportContent">
      <div class="import-tabs">
        <button class="tab-btn active" onclick="switchTab('paste')">üìã Paste JSON</button>
        <button class="tab-btn" onclick="switchTab('file')">üìÅ Upload File</button>
      </div>
      
      <div id="pasteTab" class="tab-content active">
        <textarea id="jsonTextarea" class="json-textarea" placeholder="Paste your JSON preset here..." oninput="updateTextButtons()"></textarea>
        <div class="text-buttons">
          <button id="importFromText" class="import-btn" onclick="importFromText()" disabled>üì• Import JSON</button>
          <button id="clearTextBtn" class="clear-btn" onclick="clearTextarea()" disabled>üóëÔ∏è Clear</button>
        </div>
      </div>
      
      <div id="fileTab" class="tab-content">
        <div class="file-upload-area">
          <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileSelect(event)" style="display: none;">
          <button class="file-select-btn" onclick="document.getElementById('jsonFileInput').click()">üìÅ Choose JSON File</button>
          <span id="selectedFileName" class="selected-file">No file selected</span>
        </div>
        <button id="importFromFile" class="import-btn" onclick="importFromFile()" disabled>üì• Import File</button>
      </div>
    </div>
  </div>

  <div id="moduleDetails" class="module-details">
    <h2 id="modName">Module Name</h2>
    <p><strong>Code:</strong> <span id="modCode">Not Defined</span></p>
    <p><strong>Year:</strong> <span id="modYear">Not Defined</span></p>
    <p><strong>Leader:</strong> <span id="modLeader">Not Defined</span></p>
    <p><strong>Cohort:</strong> <span id="modCohort">Not Defined</span></p>
    <div id="modTutors"><strong>Tutors:</strong><ul></ul></div>
  </div>

  <!-- First Teaching Date Section -->
  <div id="firstTeachingDateSection" class="first-teaching-date-section" style="display: none;">
    <div class="section-header" onclick="toggleFirstTeachingDate()">
      <h3>üìÖ First Teaching Date</h3>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="section-content" id="firstTeachingDateContent">
      <div class="form-row">
        <div>
          <label for="firstTeachingDate">Select the first teaching date:</label>
          <input type="date" id="firstTeachingDate" name="firstTeachingDate">
        </div>
        <div>
          <button type="button" onclick="calculateWeekDates()" class="calculate-dates-btn">üìÖ Calculate All Week Dates</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Timetable Form -->
  <form id="timetableForm"></form>
    
  <!-- Preview Controls: Preview, Open Tab, Copy HTML, Export PDF, Export Calendar -->
  <div class="sticky-footer" role="toolbar" aria-label="Timetable actions">
    <button id="previewBtn" onclick="previewTimetable()" disabled aria-label="Preview timetable">üîç Preview</button>
    <button id="openTabBtn" onclick="openPreviewInNewTab()" disabled aria-label="Open preview in new tab">üßæ New Tab</button>
    <button id="copyBtn" onclick="copyFullHTML()" disabled aria-label="Copy timetable HTML">üìã Copy</button>
    <button id="pdfBtn" onclick="exportToPDF()" disabled aria-label="Export timetable as PDF">üìÑ PDF</button>
    <button id="calendarBtn" onclick="exportToCalendar()" disabled aria-label="Export timetable as calendar file">üìÖ Calendar</button>
    <button class="reset-btn" id="resetBtn" onclick="confirmReset()" disabled aria-label="Reset all changes">üîÑ Reset</button>
  </div>
  
  <!-- iFrame Preview -->
  <iframe id="previewFrame"></iframe>

  <!-- JavaScript -->
  <script>
    let sharedPresets = {};
    let selectedPresetKey = null;
    let selectedCohort = null;

    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // Initialize theme on page load
    initTheme();

    // Toggle first teaching date section
    function toggleFirstTeachingDate() {
      const content = document.getElementById('firstTeachingDateContent');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
        localStorage.setItem('firstTeachingDateCollapsed', 'false');
      } else {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
        localStorage.setItem('firstTeachingDateCollapsed', 'true');
      }
    }

    // Initialize first teaching date section state
    function initFirstTeachingDateState() {
      const content = document.getElementById('firstTeachingDateContent');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (content && toggleIcon) {
        const isCollapsed = localStorage.getItem('firstTeachingDateCollapsed');
        
        // Default to collapsed on first load (when no state is saved)
        if (isCollapsed === null || isCollapsed === 'true') {
          content.classList.add('collapsed');
          toggleIcon.textContent = '‚ñ∂';
          toggleIcon.style.transform = 'rotate(-90deg)';
        } else {
          content.classList.remove('collapsed');
          toggleIcon.textContent = '‚ñº';
          toggleIcon.style.transform = 'rotate(0deg)';
        }
      }
    }

    // JSON Import Functions
    let selectedFile = null;

    function toggleJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
      } else {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
    }

    function openJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      content.classList.remove('collapsed');
      toggleIcon.textContent = '‚ñº';
      toggleIcon.style.transform = 'rotate(0deg)';
    }

    function closeJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      content.classList.add('collapsed');
      toggleIcon.textContent = '‚ñ∂';
      toggleIcon.style.transform = 'rotate(-90deg)';
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function updateTextButtons() {
      const textarea = document.getElementById('jsonTextarea');
      const importBtn = document.getElementById('importFromText');
      const clearBtn = document.getElementById('clearTextBtn');
      
      const hasContent = textarea.value.trim().length > 0;
      
      importBtn.disabled = !hasContent;
      clearBtn.disabled = !hasContent;
      
      // Save JSON content to localStorage
      if (hasContent) {
        localStorage.setItem('manualJsonContent', textarea.value);
      } else {
        localStorage.removeItem('manualJsonContent');
      }
    }

    function clearTextarea() {
      document.getElementById('jsonTextarea').value = '';
      localStorage.removeItem('manualJsonContent');
      updateTextButtons();
      showToast('Text area cleared', 'success');
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        document.getElementById('importFromFile').disabled = false;
        document.getElementById('selectedFileName').textContent = file.name;
        showToast(`üìÅ File selected: ${file.name}`, 'success');
      }
    }

    function importFromText() {
      const textarea = document.getElementById('jsonTextarea');
      const jsonText = textarea.value.trim();
      
      if (!jsonText) {
        showToast('Please enter JSON text to import', 'error');
        return;
      }

      try {
        const presetData = JSON.parse(jsonText);
        loadCustomPreset(presetData);
        // Save the imported JSON as manual content so it persists on refresh
        localStorage.setItem('manualJsonContent', jsonText);
        // Close JSON import section after successful import
        closeJsonImport();
        showToast('‚úÖ JSON preset imported successfully!', 'success');
      } catch (error) {
        showToast('‚ùå Invalid JSON format: ' + error.message, 'error');
      }
    }

    function importFromFile() {
      if (!selectedFile) {
        showToast('Please select a file first', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const presetData = JSON.parse(e.target.result);
          loadCustomPreset(presetData);
          // Save the imported JSON as manual content so it persists on refresh
          localStorage.setItem('manualJsonContent', e.target.result);
          // Close JSON import section after successful import
          closeJsonImport();
          showToast('‚úÖ JSON file imported successfully!', 'success');
        } catch (error) {
          showToast('‚ùå Invalid JSON file: ' + error.message, 'error');
        }
      };
      reader.readAsText(selectedFile);
    }

    function loadCustomPreset(presetData) {
      // Handle both direct object and key-value pair formats
      let data = presetData;
      if (typeof presetData === 'object' && Object.keys(presetData).length === 1) {
        // If it's a key-value pair like {"ED70013X": {...}}, extract the value
        const key = Object.keys(presetData)[0];
        data = presetData[key];
      }

      // Close JSON import section when loading custom preset
      closeJsonImport();

      // Load module details
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = data.moduleName || 'Module';
      document.getElementById("modCode").textContent = data.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = data.year || 'Not Defined';
      document.getElementById("modLeader").textContent = data.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = data.cohort || 'Not Defined';

      // Show first teaching date section
      const firstTeachingDateSection = document.getElementById("firstTeachingDateSection");
      const firstTeachingDateContent = document.getElementById("firstTeachingDateContent");
      const toggleIcon = document.querySelector('.toggle-icon');
      
      firstTeachingDateSection.style.display = "block";
      firstTeachingDateContent.classList.remove('collapsed');
      if (toggleIcon) {
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
      }

      // Update tutors
      const tutorList = document.querySelector("#modTutors ul");
      tutorList.innerHTML = "";
      if (Array.isArray(data.moduleTutors)) {
        data.moduleTutors.forEach(tutor => {
          const li = document.createElement("li");
          li.textContent = `${tutor.name} (${tutor.campus})`;
          tutorList.appendChild(li);
        });
      }

      // Clear existing weeks and add new ones
      const container = document.getElementById("timetableForm");
      container.innerHTML = "";

      // Add weeks
      (data.weeks || []).forEach(entry => {
        addWeek(entry.week, entry.topic, entry.type);
        const lastBlock = document.querySelector('.week-block:last-of-type');
        if (lastBlock) {
          lastBlock.querySelector('[name="date"]').value = entry.date || '';
          lastBlock.querySelector('[name="location"]').value = entry.location || '';
          lastBlock.querySelector('[name="highlight"]').value = entry.highlight ? 'yes' : 'no';
          updateHeader(lastBlock.id);
        }
      });

      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("pdfBtn").disabled = false;
      document.getElementById("calendarBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;
    }

    // Initialize JSON import section as collapsed
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      if (content && toggleIcon) {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
    });

    fetch('presets.json')
      .then(res => res.json())
      .then(data => {
        sharedPresets = data;
        restoreLastPreset();
      });

    // - loadPreset
    function loadPreset(presetKey) {
      console.log('Loading preset:', presetKey);

      const presetData = sharedPresets[presetKey];

      if (!presetData) {
        showToast(`‚ùå No preset found for "${presetKey}"`, "error");
        return;
      }

      // Check if this preset has multiple cohorts
      if (presetData.april && presetData.september) {
        // Show cohort selection modal
        selectedPresetKey = presetKey;
        document.getElementById('cohortModal').style.display = 'flex';
        return;
      }

      // If only one cohort exists, load it directly
      const cohort = presetData.april ? 'april' : presetData.september ? 'september' : null;
      if (cohort) {
        loadPresetWithCohort(presetKey, cohort);
      } else {
        // Fallback to old format
        loadPresetLegacy(presetKey, presetData);
      }
    }

    // - loadPresetWithCohort
    function loadPresetWithCohort(presetKey, cohort) {
      console.log('Loading preset with cohort:', presetKey, cohort);
      const container = document.getElementById("timetableForm");
      container.innerHTML = "";

      const presetData = sharedPresets[presetKey][cohort];

      if (!presetData) {
        showToast(`‚ùå No ${cohort} cohort found for "${presetKey}"`, "error");
        return;
      }

      // Save current preset and cohort to localStorage
      localStorage.setItem('currentPreset', presetKey);
      localStorage.setItem('currentCohort', cohort);
      localStorage.removeItem('manualJsonContent');
      console.log('Saved preset and cohort to localStorage:', presetKey, cohort);

      // Clear JSON textarea since we're loading a preset
      document.getElementById('jsonTextarea').value = '';
      updateTextButtons();

      // Close JSON import section when loading a preset
      closeJsonImport();

      // Update module details
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = presetData.moduleName || 'Module';
      document.getElementById("modCode").textContent = presetData.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = presetData.year || 'Not Defined';
      document.getElementById("modLeader").textContent = presetData.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = presetData.cohort || 'Not Defined';

      // Show first teaching date section and restore its state
      const firstTeachingDateSection = document.getElementById("firstTeachingDateSection");
      firstTeachingDateSection.style.display = "block";
      initFirstTeachingDateState();

      // Set first teaching date if available
      if (presetData.firstTeachingDate) {
        document.getElementById('firstTeachingDate').value = presetData.firstTeachingDate;
      }

      // Update tutors
      const tutorList = document.querySelector("#modTutors ul");
      tutorList.innerHTML = "";
      if (Array.isArray(presetData.moduleTutors)) {
        presetData.moduleTutors.forEach(tutor => {
          const li = document.createElement("li");
          li.textContent = `${tutor.name} (${tutor.campus})`;
          tutorList.appendChild(li);
        });
      }

      // Add weeks
      (presetData.weeks || []).forEach(entry => {
        addWeek(entry.week, entry.topic, entry.type);
        const lastBlock = document.querySelector('.week-block:last-of-type');
        if (lastBlock) {
          lastBlock.querySelector('[name="date"]').value = entry.date || '';
          lastBlock.querySelector('[name="location"]').value = entry.location || '';
          lastBlock.querySelector('[name="highlight"]').value = entry.highlight ? 'yes' : 'no';
          updateHeader(lastBlock.id);
        }
      });

      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("pdfBtn").disabled = false;
      document.getElementById("calendarBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;

      showToast(`‚úÖ ${presetKey} (${presetData.cohort} Cohort) loaded`, "success");
    }

    // - loadPresetLegacy (for backward compatibility)
    function loadPresetLegacy(presetKey, presetData) {
      console.log('Loading legacy preset:', presetKey);
      const container = document.getElementById("timetableForm");
      container.innerHTML = "";

      // Save current preset to localStorage and clear manual JSON content
      localStorage.setItem('currentPreset', presetKey);
      localStorage.removeItem('currentCohort');
      localStorage.removeItem('manualJsonContent');
      console.log('Saved preset to localStorage:', presetKey);

      // Clear JSON textarea since we're loading a preset
      document.getElementById('jsonTextarea').value = '';
      updateTextButtons();

      // Close JSON import section when loading a preset
      closeJsonImport();

      // Update module details (if present)
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = presetData.moduleName || 'Module';
      document.getElementById("modCode").textContent = presetData.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = presetData.year || 'Not Defined';
      document.getElementById("modLeader").textContent = presetData.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = 'Not Defined';

      // Show first teaching date section and restore its state
      const firstTeachingDateSection = document.getElementById("firstTeachingDateSection");
      firstTeachingDateSection.style.display = "block";
      initFirstTeachingDateState();

      // Update tutors
      const tutorList = document.querySelector("#modTutors ul");
      tutorList.innerHTML = "";
      if (Array.isArray(presetData.moduleTutors)) {
        presetData.moduleTutors.forEach(tutor => {
          const li = document.createElement("li");
          li.textContent = `${tutor.name} (${tutor.campus})`;
          tutorList.appendChild(li);
        });
      }

      // Add weeks
      (presetData.weeks || []).forEach(entry => {
        addWeek(entry.week, entry.topic, entry.type);
        const lastBlock = document.querySelector('.week-block:last-of-type');
        if (lastBlock) {
          lastBlock.querySelector('[name="date"]').value = entry.date || '';
          lastBlock.querySelector('[name="location"]').value = entry.location || '';
          lastBlock.querySelector('[name="highlight"]').value = entry.highlight ? 'yes' : 'no';
          updateHeader(lastBlock.id);
        }
      });

      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("pdfBtn").disabled = false;
      document.getElementById("calendarBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;

      showToast(`‚úÖ ${presetKey} loaded`, "success");
    }

    // - resetWeeks
    function resetWeeks() {
      document.getElementById("timetableForm").innerHTML = "";
      weekIdCounter = 0;
    }

    // - addWeek
    function addWeek(weekNumber = null, topicValue = "", weekType = "teaching") {
      const container = document.getElementById("timetableForm");
      const weekCount = container.children.length;
      const nextWeek = weekNumber || weekCount + 1;
      const id = `week-${weekNumber}`;

      const block = document.createElement("div");
      block.className = "week-block";
      block.id = id;
      const headerId = `header-${id}`;

      block.innerHTML = `
        <div class="week-header" id="${headerId}">
          <span class="week-title">Week ${nextWeek}: ${topicValue}</span>
          <span class="week-summary">Click to edit</span>
        </div>
        <div class="week-content">
          <div class="form-row">
            <div>
              <label>Week Number</label>
              <div class="display-field">${nextWeek}</div>
              <input type="hidden" name="week" value="${nextWeek}">
            </div>
            <div>
              <label>Week Type</label>
              <div class="display-field">${weekType === "teaching" ? "Teaching Week" : weekType === "reading" ? "Reading Week" : weekType === "break" ? "Break" : weekType === "assessment" ? "Assessment Week" : "Teaching Week"}</div>
              <input type="hidden" name="type" value="${weekType}">
            </div>
            <div>
              <label>Highlight Week?</label>
              <select name="highlight" onchange="updateHeader('${id}')">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
              </div>
          </div>
          <div class="form-row">
            <div>
              <label>Date</label>
              <input type="date" name="date" required oninput="updateHeader('${id}')">
            </div>
            <div>
              <label>Location</label>
              <input type="text" name="location" required oninput="updateHeader('${id}')">
            </div>
          </div>
          <label>Topic</label>
          <input type="text" name="topic" value="${topicValue}" required oninput="updateHeader('${id}')">
        </div>
      `;
      block.querySelector('.week-header').addEventListener('click', () => block.classList.toggle('open'));
      container.appendChild(block);

      updateHeader(id); 
    }

    // - updateHeader
    function updateHeader(id) {
      const block = document.getElementById(id);
      const week = block.querySelector('[name=week]').value;
      const topic = block.querySelector('[name=topic]').value;
      const date = block.querySelector('[name=date]').value;
      const location = block.querySelector('[name=location]').value;
      const weekType = block.querySelector('[name=type]').value;
      const highlight = block.querySelector('[name=highlight]')?.value === 'yes';

      const formattedDate = date ? new Date(date).toLocaleDateString('en-GB') : 'No date';
      const finalLocation = location || 'No location';

      block.querySelector(".week-title").textContent = `Week ${week}: ${topic} [${formattedDate} - ${finalLocation}]${highlight ? ' ‚≠ê' : ''}`;

      const header = block.querySelector(".week-header");
      header.className = 'week-header';
      if (weekType) header.classList.add(weekType);
      if (highlight) header.style.border = '2px solid #4CAF50';
      else header.style.border = 'none';
    }
  
    // - copyFullHTML
    function copyFullHTML() {
      const fullHTML = generateFullHTML();

      const temp = document.createElement('textarea');
      temp.value = fullHTML;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);

      showToast("üìã HTML copied to clipboard", "success");
    }

    // - generateFullHTML
    function generateFullHTML() {
      const form = document.getElementById('timetableForm');
      const blocks = form.querySelectorAll('.week-block');
      document.getElementById("previewFrame").style.display = "block";
      let content = '';
      showToast("üîÑ Generating preview‚Ä¶", "info");

      blocks.forEach(block => {
        const week = block.querySelector('[name=week]').value;
        const type = block.querySelector('[name=type]').value;
        const dateInput = block.querySelector('[name=date]').value;
        const date = dateInput ? new Date(dateInput).toLocaleDateString('en-GB') : 'No date';
        const location = block.querySelector('[name=location]').value || 'No location';
        const topic = block.querySelector('[name=topic]').value || 'No topic';
        const highlight = block.querySelector('[name=highlight]')?.value === 'yes';
        const weekTypeLabel = type === 'assessment' ? 'Assessment Week' : type.charAt(0).toUpperCase() + type.slice(1) + " Week";

            content += `
            <div class="week-card${highlight ? ' highlight' : ''}">
              <div class="week-title">Week ${week}</div>
              <div class="week-type ${type}">${weekTypeLabel}</div>
              <div class="session-date"><span class="tooltip"><i class="fa fa-calendar"></i><span class="tooltiptext">Session Date</span></span>${date}</div>
              <div class="session-location"><span class="tooltip"><i class="fa fa-map-marker"></i><span class="tooltiptext">Session Location</span></span>${location}</div>
              <div class="session-topic"><span class="tooltip"><i class="fa fa-book"></i><span class="tooltiptext">Session Topic</span></span>${topic}</div>
            </div>`;
          });

          return `
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
              <title>Module Timetable</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                <style>
                    body {
                    margin: 0;
                    padding: 0;
                    background: #f5f7fa;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }

                    .head {
                    background: linear-gradient(135deg, #004080, #0073e6);
                    color: #fff;
                    text-align: center;
                    padding: 20px 16px;
                    margin: 20px auto 30px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    }

                    .head h1 {
                    font-size: 2rem;
                    margin: 0;
                    text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
                    letter-spacing: 1px;
                    }

                    .timetable-container {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                    gap: 20px;
                    padding: 20px;
                    max-width: 1300px;
                    margin: 0 auto 60px;
                    }

                    .week-card {
                    background: #fff;
                    border-radius: 12px;
                    padding: 16px;
                    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                    text-align: left;
                    position: relative;
                    }

                    .week-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
                    }

                    .week-title {
                    font-size: 1.2rem;
                    font-weight: bold;
                    margin-bottom: 6px;
                    }

                    .week-type {
                    font-size: 0.9rem;
                    padding: 4px 10px;
                    border-radius: 8px;
                    display: inline-block;
                    margin-bottom: 12px;
                    }

                    .teaching { background-color: #004080; color: #fff; }
                    .reading { background-color: #f0ad4e; color: #fff; }
                    .break { background-color: #bd61d9; color: #fff; }
                    .assessment { background-color: #d9534f; color: #fff; }

                    .highlight {
                    border: 2px solid #4CAF50;
                    background-color: #e6ffe6;
                    box-sizing: border-box;
                    }
                    .assessment-badge {
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    background-color: #dc3545;
                    color: white;
                    font-size: 0.75rem;
                    padding: 4px 10px;
                    border-radius: 6px;
                    font-weight: bold;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                    }

                    .session-date {
                    font-weight: 500;
                    color: #333;
                    margin-bottom: 4px;
                    }

                    .session-location {
                    font-size: 0.95rem;
                    color: #555;
                    margin-bottom: 6px;
                    }

                    .session-topic {
                    font-size: 0.95rem;
                    color: #333;
                    }

                    .session-date i,
                    .session-topic i {
                    margin-right: 6px;
                    color: #0073e6;
                    }
                    .session-location i {
                    margin-right: 9px;
                    margin-left: 3px;
                    color: #0073e6;
                    }
                    
                    .tooltip {
                    position: relative;
                    display: inline-block;
                    cursor: help;
                    }
                    
                    .tooltip .tooltiptext {
                    visibility: hidden;
                    width: max-content;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 6px;
                    padding: 4px 8px;
                    position: absolute;
                    z-index: 10;
                    bottom: 125%;
                    left: 50%;
                    transform: translateX(-50%);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    font-size: 0.75rem;
                    white-space: nowrap;
                    }
                    
                    .tooltip:hover .tooltiptext {
                    visibility: visible;
                    opacity: 1;
                    }

                </style>
            </head>
            <body>
                <div class="head">
                    <h1>Module Timetable</h1>
                </div>

                <div class="timetable-container">
                  <!-- Use this structure for each week -->
                ${content}
                </div>
            </html>
            `.trim();
    }

    // - previewTimetable
    function previewTimetable() {
      const iframe = document.getElementById('previewFrame');
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      
      doc.open();
      doc.write(generateFullHTML());
      doc.close();
    }

    // - showToast
    function showToast(message, type = 'info') {
      const toast = document.getElementById("toast");

      toast.className = '';
      toast.classList.add('show', `toast-${type}`);
      toast.textContent = message;

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.style.display = "none";
          toast.className = '';
        }, 500);
      }, 3000);

      toast.style.display = "block";
    }

    // - openPreviewInNewTab
    function openPreviewInNewTab() {
      const form = document.getElementById('timetableForm');
      const blocks = form.querySelectorAll('.week-block');

      let content = '';
      blocks.forEach(block => {
        const week = block.querySelector('[name=week]').value;
        const type = block.querySelector('[name=type]').value;
        const dateInput = block.querySelector('[name=date]').value;
        const date = dateInput ? new Date(dateInput).toLocaleDateString('en-GB') : 'No date';
        const location = block.querySelector('[name=location]').value || 'No location';
        const topic = block.querySelector('[name=topic]').value || 'No topic';
        const highlight = block.querySelector('[name=highlight]').value === 'yes';

        const weekTypeLabel = type === 'assessment' ? 'Assessment Week' : type.charAt(0).toUpperCase() + type.slice(1) + " Week";
                content += `
                <div class="week-card${highlight ? ' highlight' : ''}">
                  <div class="week-title">Week ${week}</div>
                  <div class="week-type ${type}">${weekTypeLabel}</div>
                  <div class="session-date"><span class="tooltip"><i class="fa fa-calendar"></i><span class="tooltiptext">Session Date</span></span>${date}</div>
                  <div class="session-location"><span class="tooltip"><i class="fa fa-map-marker"></i><span class="tooltiptext">Session Location</span></span>${location}</div>
                  <div class="session-topic"><span class="tooltip"><i class="fa fa-book"></i><span class="tooltiptext">Session Topic</span></span>${topic}</div>
                </div>`;
              });

              const fullHTML = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                  <meta charset="UTF-8" />
                  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                  <title>Module Timetable</title>
                  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                    <style>
                        body {
                        margin: 0;
                        padding: 0;
                        background: #f5f7fa;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }

                        .head {
                        background: linear-gradient(135deg, #004080, #0073e6);
                        color: #fff;
                        text-align: center;
                        padding: 20px 16px;
                        margin: 20px auto 30px;
                        border-radius: 12px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        }

                        .head h1 {
                        font-size: 2rem;
                        margin: 0;
                        text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
                        letter-spacing: 1px;
                        }

                        .timetable-container {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                        padding: 20px;
                        max-width: 1300px;
                        margin: 0 auto 60px;
                        }

                        .week-card {
                        background: #fff;
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                        transition: transform 0.3s ease, box-shadow 0.3s ease;
                        text-align: left;
                        position: relative;
                        }

                        .week-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
                        }

                        .week-title {
                        font-size: 1.2rem;
                        font-weight: bold;
                        margin-bottom: 6px;
                        }

                        .week-type {
                        font-size: 0.9rem;
                        padding: 4px 10px;
                        border-radius: 8px;
                        display: inline-block;
                        margin-bottom: 12px;
                        }

                        .teaching { background-color: #004080; color: #fff; }
                        .reading { background-color: #f0ad4e; color: #fff; }
                        .break { background-color: #bd61d9; color: #fff; }
                        .assessment { background-color: #d9534f; color: #fff; }

                        .highlight {
                        border: 2px solid #4CAF50;
                        background-color: #e6ffe6;
                        box-sizing: border-box;
                        }
                        .assessment-badge {
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        background-color: #dc3545;
                        color: white;
                        font-size: 0.75rem;
                        padding: 4px 10px;
                        border-radius: 6px;
                        font-weight: bold;
                        letter-spacing: 0.5px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                        }

                        .session-date {
                        font-weight: 500;
                        color: #333;
                        margin-bottom: 4px;
                        }

                        .session-location {
                        font-size: 0.95rem;
                        color: #555;
                        margin-bottom: 6px;
                        }

                        .session-topic {
                        font-size: 0.95rem;
                        color: #333;
                        }

                        .session-date i,
                        .session-topic i {
                        margin-right: 6px;
                        color: #0073e6;
                        }
                        .session-location i {
                        margin-right: 9px;
                        margin-left: 3px;
                        color: #0073e6;
                        }
                        
                        .tooltip {
                        position: relative;
                        display: inline-block;
                        cursor: help;
                        }
                        
                        .tooltip .tooltiptext {
                        visibility: hidden;
                        width: max-content;
                        background-color: #333;
                        color: #fff;
                        text-align: center;
                        border-radius: 6px;
                        padding: 4px 8px;
                        position: absolute;
                        z-index: 10;
                        bottom: 125%;
                        left: 50%;
                        transform: translateX(-50%);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                        font-size: 0.75rem;
                        white-space: nowrap;
                        }
                        
                        .tooltip:hover .tooltiptext {
                        visibility: visible;
                        opacity: 1;
                        }

                    </style>
                </head>
                <body>
                    <div class="head">
                        <h1>Module Timetable</h1>
                    </div>

                    <div class="timetable-container">
                      <!-- Use this structure for each week -->
                    ${content}
                    </div>
                </html>
                `.trim();

      const blob = new Blob([fullHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');

      showToast("üßæ Opening preview in new tab...", "info");
    }

    // - confirmReset
    function confirmReset() {
      document.getElementById('resetModal').style.display = 'flex';
    }

    // - closeModal
    function closeModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    // - selectCohort
    function selectCohort(cohort) {
      if (selectedPresetKey) {
        loadPresetWithCohort(selectedPresetKey, cohort);
        closeCohortModal();
      }
    }

    // - closeCohortModal
    function closeCohortModal() {
      document.getElementById('cohortModal').style.display = 'none';
      selectedPresetKey = null;
    }

    // - restoreLastPreset
    function restoreLastPreset() {
      const manualJsonContent = localStorage.getItem('manualJsonContent');
      
      // If there's manual JSON content, restore it and load the data
      if (manualJsonContent && manualJsonContent.trim().length > 0) {
        const textarea = document.getElementById('jsonTextarea');
        textarea.value = manualJsonContent;
        updateTextButtons();
        console.log('Restored manual JSON content from localStorage');
        
        // Automatically load the JSON data into the form
        try {
          const presetData = JSON.parse(manualJsonContent);
          loadCustomPreset(presetData);
          console.log('Automatically loaded JSON data on page refresh');
        } catch (error) {
          console.error('Failed to parse restored JSON:', error);
        }
        return;
      }
      
      // Otherwise, try to restore the last preset
      const lastPreset = localStorage.getItem('currentPreset');
      const lastCohort = localStorage.getItem('currentCohort');
      console.log('Restoring preset:', lastPreset, 'cohort:', lastCohort);
      
      if (lastPreset && sharedPresets[lastPreset]) {
        if (lastCohort && sharedPresets[lastPreset][lastCohort]) {
          // Restore specific cohort
          console.log('Loading preset with cohort:', lastPreset, lastCohort);
          loadPresetWithCohort(lastPreset, lastCohort);
        } else {
          // Try to load preset (will show cohort selection if needed)
        console.log('Loading preset:', lastPreset);
        loadPreset(lastPreset);
        }
      } else {
        console.log('No preset to restore or preset not found');
        // Open JSON import section when no data is available
        openJsonImport();
      }
    }

    // - exportToPDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      
      // Get module details
      const moduleName = document.getElementById('modName').textContent;
      const moduleCode = document.getElementById('modCode').textContent;
      const moduleYear = document.getElementById('modYear').textContent;
      const moduleLeader = document.getElementById('modLeader').textContent;
      const moduleCohort = document.getElementById('modCohort').textContent;
      
      // Get tutors
      const tutorElements = document.querySelectorAll('#modTutors ul li');
      const tutors = Array.from(tutorElements).map(li => li.textContent).join(', ');
      
      // Get weeks data
      const weekBlocks = document.querySelectorAll('.week-block');
      const weeks = Array.from(weekBlocks).map(block => {
        const week = block.querySelector('[name="week"]').value;
        const topic = block.querySelector('[name="topic"]').value;
        const type = block.querySelector('[name="type"]').value;
        const date = block.querySelector('[name="date"]').value;
        const location = block.querySelector('[name="location"]').value;
        const highlight = block.querySelector('[name="highlight"]').value === 'yes';
        
        return {
          week,
          topic,
          type,
          date: date ? new Date(date).toLocaleDateString('en-GB') : 'No date',
          location: location || 'No location',
          highlight
        };
      });
      
      // Set up PDF dimensions for landscape
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;
      const margin = 15;
      const tableStartY = 60;
      
      // Title
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('Module Timetable', pageWidth / 2, 20, { align: 'center' });
      
      // Module details header
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text('Module Information:', margin, 35);
      
      // Module details
      doc.setFont(undefined, 'normal');
      doc.setFontSize(8);
      doc.text(`Name: ${moduleName}`, margin, 42);
      doc.text(`Code: ${moduleCode}`, margin, 48);
      doc.text(`Year: ${moduleYear}`, margin, 54);
      doc.text(`Leader: ${moduleLeader}`, margin + 80, 42);
      doc.text(`Cohort: ${moduleCohort}`, margin + 80, 48);
      doc.text(`Tutors: ${tutors}`, margin + 80, 54);
      
      // Table headers
      const headers = ['Week', 'Topic', 'Type', 'Date', 'Location'];
      const columnWidths = [20, 80, 30, 35, 50];
      const startX = margin;
      let currentX = startX;
      
      // Draw table headers
      doc.setFontSize(9);
      doc.setFont(undefined, 'bold');
      headers.forEach((header, index) => {
        doc.text(header, currentX, tableStartY);
        currentX += columnWidths[index];
      });
      
      // Draw header line
      doc.line(startX, tableStartY + 2, startX + columnWidths.reduce((a, b) => a + b, 0), tableStartY + 2);
      
      // Table data
      doc.setFont(undefined, 'normal');
      doc.setFontSize(8);
      let currentY = tableStartY + 10;
      
      weeks.forEach((week, index) => {
        // Check if we need a new page
        if (currentY > pageHeight - 30) {
          doc.addPage('landscape');
          currentY = 20;
          
          // Redraw headers on new page
          doc.setFont(undefined, 'bold');
          currentX = startX;
          headers.forEach((header, headerIndex) => {
            doc.text(header, currentX, currentY);
            currentX += columnWidths[headerIndex];
          });
          doc.line(startX, currentY + 2, startX + columnWidths.reduce((a, b) => a + b, 0), currentY + 2);
          currentY += 10;
        }
        
        // Draw row background for highlighted weeks
        if (week.highlight) {
          doc.setFillColor(255, 255, 0); // Light yellow background
          doc.rect(startX, currentY - 4, columnWidths.reduce((a, b) => a + b, 0), 6, 'F');
        }
        
        // Draw row data
        currentX = startX;
        const rowData = [
          week.week,
          week.topic,
          week.type.charAt(0).toUpperCase() + week.type.slice(1),
          week.date,
          week.location
        ];
        
        rowData.forEach((cell, cellIndex) => {
          // Truncate long text
          let displayText = cell;
          if (cellIndex === 1 && cell.length > 35) { // Topic column
            displayText = cell.substring(0, 32) + '...';
          } else if (cellIndex === 4 && cell.length > 20) { // Location column
            displayText = cell.substring(0, 17) + '...';
          }
          
          doc.text(displayText, currentX, currentY);
          currentX += columnWidths[cellIndex];
        });
        
        currentY += 6;
      });
      
      // Save the PDF
      const fileName = `${moduleCode || 'timetable'}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
      showToast('üìÑ PDF exported successfully!', 'success');
    }

    // - exportToCalendar
    function exportToCalendar() {
      // Get module details
      const moduleName = document.getElementById('modName').textContent;
      const moduleCode = document.getElementById('modCode').textContent;
      const moduleYear = document.getElementById('modYear').textContent;
      const moduleLeader = document.getElementById('modLeader').textContent;
      const moduleCohort = document.getElementById('modCohort').textContent;
      
      // Get weeks data
      const weekBlocks = document.querySelectorAll('.week-block');
      if (weekBlocks.length === 0) {
        showToast('‚ùå No weeks found. Please load a preset first.', 'error');
        return;
      }

      // Generate ICS content
      let icsContent = generateICSContent(moduleName, moduleCode, moduleYear, moduleLeader, moduleCohort, weekBlocks);
      
      // Create and download the file immediately
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${moduleCode || 'timetable'}_${moduleCohort}_${new Date().toISOString().split('T')[0]}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Show modal with instructions
      document.getElementById('calendarModal').style.display = 'flex';
    }

    // - closeCalendarModal
    function closeCalendarModal() {
      document.getElementById('calendarModal').style.display = 'none';
    }

    // - toggleCalendarSection
    function toggleCalendarSection(section) {
      const sections = ['outlook', 'google', 'apple', 'other'];
      const content = document.getElementById(section + 'Content');
      const icon = document.getElementById(section + 'Icon');
      
      // If the clicked section is currently collapsed, expand it and collapse others
      if (content.style.display === 'none') {
        // Collapse all sections first
        sections.forEach(s => {
          const sContent = document.getElementById(s + 'Content');
          const sIcon = document.getElementById(s + 'Icon');
          const sHeader = document.querySelector(`[onclick="toggleCalendarSection('${s}')"]`);
          
          sContent.style.display = 'none';
          sIcon.textContent = '‚ñº';
          sHeader.style.background = 'var(--card-bg)';
          sHeader.style.color = 'var(--text-primary)';
        });
        
        // Expand the clicked section
        content.style.display = 'block';
        icon.textContent = '‚ñ≤';
        const header = document.querySelector(`[onclick="toggleCalendarSection('${section}')"]`);
        header.style.background = 'var(--button-primary)';
        header.style.color = 'white';
      } else {
        // If the clicked section is already expanded, collapse it
        content.style.display = 'none';
        icon.textContent = '‚ñº';
        const header = document.querySelector(`[onclick="toggleCalendarSection('${section}')"]`);
        header.style.background = 'var(--card-bg)';
        header.style.color = 'var(--text-primary)';
      }
    }

    // - generateICSContent
    function generateICSContent(moduleName, moduleCode, moduleYear, moduleLeader, moduleCohort, weekBlocks) {
      const now = new Date();
      const nowString = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      
      let icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//MScSimEd Timetable Generator//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        `X-WR-CALNAME:${moduleCode} - ${moduleName}`,
        `X-WR-CALDESC:Module timetable for ${moduleName} (${moduleCohort} Cohort)`
      ];

      weekBlocks.forEach((block, index) => {
        const week = block.querySelector('[name="week"]').value;
        const topic = block.querySelector('[name="topic"]').value || 'No topic';
        const type = block.querySelector('[name="type"]').value;
        const dateInput = block.querySelector('[name="date"]').value;
        const location = block.querySelector('[name="location"]').value || 'Location TBC';
        const highlight = block.querySelector('[name="highlight"]').value === 'yes';
        
        if (!dateInput) {
          // Skip weeks without dates
          return;
        }

        const eventDate = new Date(dateInput);
        const eventDateString = eventDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        
        // Set start time to 09:00 and end time to 17:00
        const startDate = new Date(eventDate);
        startDate.setHours(9, 0, 0, 0); // 09:00 AM
        const endDate = new Date(eventDate);
        endDate.setHours(17, 0, 0, 0); // 17:00 PM
        const startDateString = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const endDateString = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

        // Create event description
        const description = [
          `Week ${week}: ${topic}`,
          `Type: ${type.charAt(0).toUpperCase() + type.slice(1)} Week`,
          `Module: ${moduleName} (${moduleCode})`,
          `Year: ${moduleYear}`,
          `Module Leader: ${moduleLeader}`,
          `Cohort: ${moduleCohort}`,
          highlight ? '‚≠ê Highlighted Week' : ''
        ].filter(line => line).join('\\n');

        // Create event summary (title)
        const summary = `Week ${week}: ${topic} - ${moduleCode}`;

        // Add color coding based on week type
        let color = '';
        switch(type) {
          case 'assessment':
            color = 'COLOR:#FF0000'; // Red for assessment
            break;
          case 'reading':
            color = 'COLOR:#0000FF'; // Blue for reading
            break;
          case 'break':
            color = 'COLOR:#808080'; // Gray for break
            break;
          default:
            color = 'COLOR:#008000'; // Green for teaching
        }

        // Add event to calendar
        icsContent.push(
          'BEGIN:VEVENT',
          `UID:${moduleCode}_week${week}_${eventDateString}`,
          `DTSTAMP:${nowString}`,
          `DTSTART:${startDateString}`,
          `DTEND:${endDateString}`,
          `SUMMARY:${summary}`,
          `DESCRIPTION:${description}`,
          `LOCATION:${location}`,
          color,
          'END:VEVENT'
        );
      });

      icsContent.push('END:VCALENDAR');
      
      return icsContent.join('\r\n');
    }

    // - calculateWeekDates
    function calculateWeekDates() {
      const firstTeachingDate = document.getElementById('firstTeachingDate').value;
      if (!firstTeachingDate) {
        showToast('‚ùå Please select a first teaching date first', 'error');
        return;
      }

      const weekBlocks = document.querySelectorAll('.week-block');
      if (weekBlocks.length === 0) {
        showToast('‚ùå No weeks found. Please load a preset first.', 'error');
        return;
      }

      const startDate = new Date(firstTeachingDate);
      
      weekBlocks.forEach((block, index) => {
        const weekDate = new Date(startDate);
        weekDate.setDate(startDate.getDate() + (index * 7));
        const dateString = weekDate.toISOString().split('T')[0];
        
        const dateInput = block.querySelector('[name="date"]');
        if (dateInput) {
          dateInput.value = dateString;
          updateHeader(block.id);
        }
      });

      showToast(`‚úÖ Dates calculated for ${weekBlocks.length} weeks starting from ${new Date(firstTeachingDate).toLocaleDateString('en-GB')}`, 'success');
    }

    // - performReset
    function performReset() {
      resetWeeks();
      closeModal();
      showToast("üîÑ Timetable changes reset.", "success");

      // Clear localStorage
      localStorage.removeItem('currentPreset');
      localStorage.removeItem('currentCohort');
      localStorage.removeItem('manualJsonContent');

      document.getElementById("previewBtn").disabled = true;
      document.getElementById("openTabBtn").disabled = true;
      document.getElementById("copyBtn").disabled = true;
      document.getElementById("pdfBtn").disabled = true;
      document.getElementById("resetBtn").disabled = true;

      // Hide module details
      document.getElementById("moduleDetails").style.display = "none";
      document.getElementById("firstTeachingDateSection").style.display = "none";
      document.getElementById("previewFrame").style.display = "none";

      // Clear values
      document.getElementById("modName").textContent = "Module Name";
      document.getElementById("modCode").textContent = "Not Defined";
      document.getElementById("modYear").textContent = "Not Defined";
      document.getElementById("modLeader").textContent = "Not Defined";
      document.getElementById("modCohort").textContent = "Not Defined";
      document.querySelector("#modTutors ul").innerHTML = "";
      document.getElementById("firstTeachingDate").value = "";

      // Clear JSON textarea
      document.getElementById("jsonTextarea").value = "";
      updateTextButtons();

      // Open JSON import section after reset
      openJsonImport();

      const iframe = document.getElementById("previewFrame");
      if (iframe) iframe.srcdoc = "";
    }

    
  </script>

  <!-- Modal for Reset Confirmation -->
  <div id="resetModal" class="modal-overlay">
    <div class="modal-box">
      <h3>Are you sure?</h3>
      <p>This will remove all current weeks from the timetable.</p>
      <div class="modal-actions">
        <button onclick="closeModal()" class="cancel-btn">Cancel</button>
        <button onclick="performReset()" class="confirm-btn">Yes, Reset</button>
      </div>
    </div>
  </div>

  <!-- Modal for Cohort Selection -->
  <div id="cohortModal" class="modal-overlay">
    <div class="modal-box">
      <h3>Select Cohort</h3>
      <p>Choose which cohort you want to load:</p>
      <div class="cohort-options">
        <button onclick="selectCohort('april')" class="cohort-btn">üå± April Cohort</button>
        <button onclick="selectCohort('september')" class="cohort-btn">üçÇ September Cohort</button>
      </div>
      <div class="modal-actions">
        <button onclick="closeCohortModal()" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal for Calendar Export Instructions -->
  <div id="calendarModal" class="modal-overlay">
    <div class="modal-box">
      <h3>üìÖ Calendar Exported!</h3>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Your calendar file has been downloaded. Here's how to import it:</p>
      
      <!-- Microsoft Outlook (Expanded by default) -->
      <div style="margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <div class="section-header" onclick="toggleCalendarSection('outlook')" style="cursor: pointer; padding: 15px 20px; background: var(--button-primary); color: white; display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center;">
            <i class="fab fa-microsoft" style="font-size: 1.2rem; margin-right: 10px; color: #0078d4;"></i>
            <span style="font-weight: 500;">Microsoft Outlook</span>
          </div>
          <span class="toggle-icon" id="outlookIcon">‚ñ≤</span>
        </div>
        <div class="section-content" id="outlookContent" style="display: block; padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border-color);">
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 1:</strong> Double-click the downloaded .ics file
          </p>
          <p style="margin: 0; color: var(--text-primary);">
            <strong>Step 2:</strong> File ‚Üí Open & Export ‚Üí Import/Export ‚Üí Import iCalendar (.ics)
          </p>
        </div>
      </div>
      
      <!-- Google Calendar -->
      <div style="margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <div class="section-header" onclick="toggleCalendarSection('google')" style="cursor: pointer; padding: 15px 20px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center;">
            <i class="fab fa-google" style="font-size: 1.2rem; margin-right: 10px; color: #4285f4;"></i>
            <span style="font-weight: 500; color: var(--text-primary);">Google Calendar</span>
          </div>
          <span class="toggle-icon" id="googleIcon">‚ñº</span>
        </div>
        <div class="section-content" id="googleContent" style="display: none; padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border-color);">
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 1:</strong> Open Google Calendar in your browser
          </p>
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 2:</strong> Click the gear icon (Settings) in the top right
          </p>
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 3:</strong> Go to "Import & Export" in the left sidebar
          </p>
          <p style="margin: 0; color: var(--text-primary);">
            <strong>Step 4:</strong> Click "Select file from your computer" and choose your .ics file
          </p>
        </div>
      </div>
      
      <!-- Apple Calendar -->
      <div style="margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <div class="section-header" onclick="toggleCalendarSection('apple')" style="cursor: pointer; padding: 15px 20px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center;">
            <i class="fab fa-apple" style="font-size: 1.2rem; margin-right: 10px; color: #000000;"></i>
            <span style="font-weight: 500; color: var(--text-primary);">Apple Calendar</span>
          </div>
          <span class="toggle-icon" id="appleIcon">‚ñº</span>
        </div>
        <div class="section-content" id="appleContent" style="display: none; padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border-color);">
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 1:</strong> Double-click the downloaded .ics file
          </p>
          <p style="margin: 0; color: var(--text-primary);">
            <strong>Step 2:</strong> Or drag the .ics file directly into the Calendar app
          </p>
        </div>
      </div>
      
      <!-- Other Calendar Apps -->
      <div style="margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <div class="section-header" onclick="toggleCalendarSection('other')" style="cursor: pointer; padding: 15px 20px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-calendar-alt" style="font-size: 1.2rem; margin-right: 10px; color: #6c757d;"></i>
            <span style="font-weight: 500; color: var(--text-primary);">Other Calendar Apps</span>
          </div>
          <span class="toggle-icon" id="otherIcon">‚ñº</span>
        </div>
        <div class="section-content" id="otherContent" style="display: none; padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border-color);">
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 1:</strong> Open your calendar application
          </p>
          <p style="margin: 0 0 10px 0; color: var(--text-primary);">
            <strong>Step 2:</strong> Look for an "Import", "Add Calendar", or "Subscribe" option in the settings or menu
          </p>
          <p style="margin: 0; color: var(--text-primary);">
            <strong>Step 3:</strong> Select the downloaded .ics file when prompted
          </p>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: var(--input-bg); border-radius: 8px; border-left: 4px solid var(--button-primary);">
        <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
          <strong>üìã Event Details:</strong> Each week appears as a full-day event (09:00-17:00) with module details and color coding.
        </p>
      </div>
      
      <div class="modal-actions">
        <button onclick="closeCalendarModal()" class="confirm-btn">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast" style="display: none;"></div>

</body>
</html>