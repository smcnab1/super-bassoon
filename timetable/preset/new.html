<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Module Timetable Generator</title>
  <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="../../auth.js"></script>
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --error-color: #dc3545;
      --error-color-hover: #c82333;
      --success-color: #28a745;
      --success-color-hover: #218838;
      --hover-bg: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --error-color: #e74c3c;
      --error-color-hover: #c0392b;
      --success-color: #27ae60;
      --success-color-hover: #229954;
      --hover-bg: rgba(255, 255, 255, 0.05);
    }

    /* Modern responsive design for preset form */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Form layout improvements */
    .form-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px var(--shadow-color-light);
    }

    .form-section h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.4rem;
      font-weight: 600;
    }

    /* Improved form row layout */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-row > div {
      display: flex;
      flex-direction: column;
    }

    .form-row label {
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-row label.required::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
      margin-left: 4px;
    }

    [data-theme="dark"] .form-row label.required::after {
      color: #e74c3c;
    }

    /* Table header required styling */
    #weekTable th .required::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
      margin-left: 4px;
    }

    [data-theme="dark"] #weekTable th .required::after {
      color: #e74c3c;
    }

    .form-row input,
    .form-row select {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    .form-row input:focus,
    .form-row select:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px var(--input-focus-shadow);
    }

    /* Tutor section improvements */
    .tutor-section {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .tutor-section label {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .compact-tutor {
      grid-template-columns: 1fr 1fr 40px;
      gap: 12px;
      align-items: end;
      margin-bottom: 12px;
    }

    .compact-tutor > div {
      display: flex;
      flex-direction: column;
    }

    .compact-tutor input,
    .compact-tutor select {
      margin-bottom: 0;
    }

    .compact-tutor button {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      min-width: auto;
      margin: 0;
    }

    .button-placeholder {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      margin: 0 auto;
    }

    /* Table improvements */
    #weekTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-color-light);
      margin-bottom: 16px;
    }

    #weekTable th {
      background: var(--navbar-bg);
      color: white;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }

    #weekTable td {
      padding: 6px 12px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    #weekTable tr:last-child td {
      border-bottom: none;
    }

    #weekTable input,
    #weekTable select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    #weekTable input:focus,
    #weekTable select:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    /* Action buttons in table */
    .action-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .action-buttons button {
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      min-width: auto;
      margin: 0;
      background: var(--button-secondary);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .action-buttons button:hover {
      background: var(--button-secondary-hover);
    }

    .action-buttons button[onclick*="removeRow"],
    .action-buttons button[onclick*="removeWeekRow"] {
      background: #8b0000 !important;
      font-weight: bold !important;
    }

    .action-buttons button[onclick*="removeRow"]:hover,
    .action-buttons button[onclick*="removeWeekRow"]:hover {
      background: #660000 !important;
    }

    [data-theme="dark"] .action-buttons button[onclick*="removeRow"],
    [data-theme="dark"] .action-buttons button[onclick*="removeWeekRow"] {
      background: #a52a2a !important;
    }

    [data-theme="dark"] .action-buttons button[onclick*="removeRow"]:hover,
    [data-theme="dark"] .action-buttons button[onclick*="removeWeekRow"]:hover {
      background: #8b0000 !important;
    }

    /* Up and down arrow button styling */
    .action-buttons button[onclick*="moveWeekUp"],
    .action-buttons button[onclick*="moveWeekDown"] {
      background: var(--button-primary) !important;
      font-weight: bold !important;
    }

    .action-buttons button[onclick*="moveWeekUp"]:hover,
    .action-buttons button[onclick*="moveWeekDown"]:hover {
      background: var(--button-primary-hover) !important;
    }

    /* Week number styling */
    .week-number {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }

    /* Add buttons */
    .add-button {
      background: var(--button-primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }

    .add-button:hover {
      background: var(--button-primary-hover);
      transform: translateY(-1px);
    }

    /* Add Weeks Row Alignment */
    .add-weeks-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }
    .add-weeks-left {
      display: flex;
      align-items: center;
    }
    .add-weeks-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .add-button,
    .add-multiple-button,
    .weeks-input {
      height: 44px;
      line-height: 44px;
      font-size: 1rem;
      margin: 0;
      vertical-align: middle;
    }
    .add-button {
      padding: 0 24px;
      border-radius: 8px;
      font-weight: 500;
    }
    .add-multiple-button {
      padding: 0 24px;
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .weeks-input {
      width: 60px;
      padding: 0 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      text-align: center;
      box-sizing: border-box;
      appearance: none;
      -webkit-appearance: none;
    }

    /* Sticky footer improvements */
    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--navbar-bg);
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      box-shadow: 0 -2px 10px var(--shadow-color);
      z-index: 100;
    }

    .sticky-footer button {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 140px;
    }

    .sticky-footer button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .sticky-footer button:not(:disabled):hover {
      transform: translateY(-1px);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .form-section {
        padding: 16px;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .compact-tutor {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      #weekTable {
        font-size: 0.85rem;
      }

      #weekTable th,
      #weekTable td {
        padding: 8px 6px;
      }

      .action-buttons {
        flex-direction: column;
        gap: 2px;
      }

      .action-buttons button {
        padding: 4px 6px;
        font-size: 0.75rem;
      }

      .add-weeks-section {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .add-multiple-weeks {
        justify-content: center;
      }

      .sticky-footer {
        padding: 12px 16px;
        gap: 8px;
      }

      .sticky-footer button {
        padding: 10px 16px;
        font-size: 0.9rem;
        min-width: 120px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }

      .form-section {
        padding: 12px;
      }

      .sticky-footer {
        flex-direction: column;
        align-items: center;
      }

      .sticky-footer button {
        width: 100%;
        max-width: 300px;
      }
    }

    /* Loading states */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Smooth transitions */
    * {
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* Additional optimizations */
    .container h1 {
      margin-bottom: 32px;
      color: var(--text-primary);
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
    }

    /* Better spacing for form sections */
    .form-section + .form-section {
      margin-top: 32px;
    }

    /* Improved input states */
    .form-row input:invalid,
    .form-row select:invalid {
      border-color: var(--error-color);
    }

    .form-row input:valid,
    .form-row select:valid {
      border-color: var(--success-color);
    }

    /* Better button styling */
    .remove-btn {
      background: #8b0000;
      color: white;
      border: none;
      padding: 8px 8px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: bold;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn:hover {
      background: #660000;
      transform: scale(1.05);
    }

    [data-theme="dark"] .remove-btn {
      background: #a52a2a;
    }

    [data-theme="dark"] .remove-btn:hover {
      background: #8b0000;
    }

    /* Table row hover effects */
    #weekTable tbody tr:hover {
      background: var(--hover-bg);
    }

    /* Better focus indicators */
    .form-row input:focus,
    .form-row select:focus,
    #weekTable input:focus,
    #weekTable select:focus {
      transform: translateY(-1px);
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Improved mobile experience */
    @media (max-width: 480px) {
      .container h1 {
        font-size: 1.5rem;
        margin-bottom: 24px;
      }

      .form-section h2 {
        font-size: 1.2rem;
      }

      .form-row input,
      .form-row select {
        font-size: 16px; /* Prevents zoom on iOS */
      }

      /* Stack action buttons vertically on very small screens */
      .action-buttons {
        flex-direction: column;
        gap: 2px;
      }

      .action-buttons button {
        padding: 6px 8px;
        font-size: 0.75rem;
      }
    }

    /* Accessibility improvements */
    .form-row input:focus,
    .form-row select:focus,
    #weekTable input:focus,
    #weekTable select:focus,
    .action-buttons button:focus,
    .add-button:focus {
      outline: 2px solid var(--input-focus);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .form-row input,
      .form-row select,
      #weekTable input,
      #weekTable select {
        border-width: 2px;
      }

      .action-buttons button {
        border: 2px solid currentColor;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        animation: none !important;
      }
    }

    /* Custom toggle switch for exportForPresetsJson */
    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
      vertical-align: middle;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 26px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    input:checked + .slider {
      background-color: #0073e6;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    .switch-label {
      margin-left: 12px;
      font-size: 1em;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
    }
    .sticky-footer {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    /* Advanced Settings Section */
    .advanced-settings {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      overflow: hidden;
    }

    .advanced-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }

    .advanced-header:hover {
      background: var(--hover-bg);
    }

    .advanced-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
    }

    .advanced-toggle-icon {
      color: var(--text-secondary);
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }

    .advanced-content {
      padding: 20px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    .advanced-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .advanced-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .advanced-option .switch-label {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.95rem;
    }

    .advanced-description {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 4px;
      margin-left: 60px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="main-navbar">
    <div class="navbar-title">
      <a href="../../../index.html" style="text-decoration: none; color: inherit;">
        <div class="title-main">ü§ñ MScSimEd</div>
      </a>
      <span class="title-separator">|</span>
      <div class="title-subtitle">üìÑ New Preset</div>
    </div>
    <div class="navbar-links">
      <div class="dropdown">
        <button class="dropdown-btn">üìÖ Timetable</button>
        <div class="dropdown-content">
          <a href="../generate.html">üéØ Generate</a>
          <a href="new.html">üìÑ New Preset</a>
          <a href="edit.html">‚úèÔ∏è Edit Preset</a>
        </div>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
    </div>
  </nav>

  <div class="container">
    <h1>New Module Preset</h1>

    <div class="form-section">
      <h2>Module Details</h2>
      <form id="moduleDetailsInput">
        <div class="form-row">
          <div><label class="required">Module Name</label><input type="text" name="moduleName" required placeholder="Enter module name"></div>
        </div>
        <div class="form-row">
          <div><label class="required">Module Code</label><input type="text" name="moduleCode" required placeholder="e.g., ED70011X"></div>
          <div><label class="required">Year</label><select name="year" required>
            <option value="">Select Year</option>
            <option value="1">Year 1</option>
            <option value="2">Year 2</option>
            <option value="3">Year 3</option>
          </select></div>
        </div>
        <div class="form-row">
          <div><label class="required">Module Leader</label><input type="text" name="moduleLeader" required placeholder="Enter module leader name"></div>
          <div><label class="required">Cohort</label><select name="cohort" required>
            <option value="">Select Cohort</option>
            <option value="april">üå± April Cohort</option>
            <option value="september">üçÇ September Cohort</option>
          </select></div>
        </div>
      </form>
    </div>

    <div class="form-section" id="tutorSection" style="display: none;">
      <h2>Module Tutors (Optional)</h2>
      <div id="tutorContainer">
        <div class="form-row compact-tutor tutor-row">
          <div><input type="text" name="tutorName" placeholder="Tutor Name" /></div>
          <div><select name="tutorCampus">
            <option value="">Select Campus</option>
            <option value="London">London</option>
            <option value="Reading">Reading</option>
          </select></div>
          <div class="button-placeholder"></div>
        </div>
      </div>
      <button type="button" onclick="addTutor()" class="add-button">‚ûï Add Tutor</button>
    </div>

    <div class="form-section" id="weekSection" style="display: none;">
      <h2>Weekly Breakdown</h2>
      <table id="weekTable">
        <thead>
          <tr>
            <th>Week #</th>
            <th><span class="required">Type</span></th>
            <th>Highlight</th>
            <th><span class="required">Topic</span></th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="weekBody">
          <tr class="week-row">
            <td><span class="week-number">1</span></td>
            <td><select name="weekType" required>
              <option value="">Select Type</option>
              <option value="teaching">Teaching</option>
              <option value="reading">Reading</option>
              <option value="assessment">Assessment</option>
              <option value="break">Break</option>
            </select></td>
            <td><select name="highlight">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select></td>
            <td><input type="text" name="topic" required placeholder="Enter topic"></td>
            <td>
              <div class="action-buttons">
                <button type="button" onclick="moveWeekUp(this)" title="Move week up">‚¨ÜÔ∏è</button>
                <button type="button" onclick="moveWeekDown(this)" title="Move week down">‚¨áÔ∏è</button>
                <button type="button" onclick="removeWeekRow(this)" title="Remove week">‚ùå</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="add-weeks-row">
        <div class="add-weeks-left">
          <button type="button" onclick="addRow()" class="add-button">‚ûï Add Week</button>
        </div>
        <div class="add-weeks-right">
          <input type="number" id="weeksToAdd" min="1" max="25" value="1" class="weeks-input">
          <button type="button" onclick="addMultipleWeeks()" class="add-multiple-button">‚ûï Add Weeks</button>
        </div>
      </div>
    </div>
  </div>
  <div class="sticky-footer">
    <button onclick="copyPresetJSON()">üìã Copy Preset JSON</button>
    <button onclick="downloadPresetJSON()">üíæ Download Preset JSON</button>
    <button onclick="confirmReset()" class="reset-btn">üîÑ Reset</button>
  </div>

  <!-- Advanced Settings Section -->
  <div class="advanced-settings">
    <div class="advanced-header" onclick="toggleAdvancedSettings()">
      <h3>‚öôÔ∏è Advanced Settings</h3>
      <span class="advanced-toggle-icon">‚ñº</span>
    </div>
    <div class="advanced-content" id="advancedContent">
      <div class="advanced-option">
        <label class="switch" title="Export for presets.json">
          <input type="checkbox" id="exportForPresetsJson" />
          <span class="slider"></span>
        </label>
        <span class="switch-label" onclick="document.getElementById('exportForPresetsJson').click()">Export for presets.json</span>
      </div>
      <div class="advanced-description">
        When enabled, exports the preset in the format required for direct inclusion in presets.json file.
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // Initialize theme on page load
    initTheme();

    // Load saved data on page load
    loadSavedData();

    // Auto-save data when form fields change
    setupAutoSave();

    // Update week numbers on page load
    updateWeekNumbers();
    
    // Update button states on page load
    updateButtonStates();

    // Check module details and show/hide sections accordingly
    checkModuleDetails();

    function getPresetData() {
      const moduleName = document.querySelector('[name="moduleName"]').value;
      const moduleCode = document.querySelector('[name="moduleCode"]').value;
      const year = document.querySelector('[name="year"]').value;
      const moduleLeader = document.querySelector('[name="moduleLeader"]').value;
      const cohort = document.querySelector('[name="cohort"]').value;

      const tutorElements = document.querySelectorAll('.tutor-row');
      const moduleTutors = Array.from(tutorElements).map(row => ({
        name: row.querySelector('[name="tutorName"]').value,
        campus: row.querySelector('[name="tutorCampus"]').value
      }));

      const weekElements = document.querySelectorAll('.week-row');
      const weeks = Array.from(weekElements).map((row, index) => ({
        week: index + 1,
        type: row.querySelector('[name="weekType"]').value,
        highlight: row.querySelector('[name="highlight"]').value === 'yes',
        date: '',
        location: 'Location TBC',
        topic: row.querySelector('[name="topic"]').value
      }));

      return {
        moduleName,
        moduleCode,
        year,
        moduleLeader,
        cohort,
        moduleTutors,
        weeks
      };
    }

    function validateForm() {
      const errors = [];
      
      // Check module details
      const moduleName = document.querySelector('[name="moduleName"]').value.trim();
      const moduleCode = document.querySelector('[name="moduleCode"]').value.trim();
      const year = document.querySelector('[name="year"]').value;
      const moduleLeader = document.querySelector('[name="moduleLeader"]').value.trim();
      const cohort = document.querySelector('[name="cohort"]').value;
      
      if (!moduleName) errors.push("Module Name is required");
      if (!moduleCode) errors.push("Module Code is required");
      if (!year) errors.push("Year is required");
      if (!moduleLeader) errors.push("Module Leader is required");
      if (!cohort) errors.push("Cohort is required");
      
      // Check weeks - use array index instead of reading from DOM
      const weekElements = document.querySelectorAll('.week-row');
      weekElements.forEach((row, index) => {
        const weekNumber = index + 1; // Use array index + 1 instead of reading from DOM
        const weekType = row.querySelector('[name="weekType"]').value;
        const topic = row.querySelector('[name="topic"]').value.trim();
        
        if (!weekType) errors.push(`Week ${weekNumber}: Type is required`);
        if (!topic) errors.push(`Week ${weekNumber}: Topic is required`);
      });
      
      return errors;
    }

    function updateButtonStates() {
      const errors = validateForm();
      const copyBtn = document.querySelector('button[onclick="copyPresetJSON()"]');
      const downloadBtn = document.querySelector('button[onclick="downloadPresetJSON()"]');
      
      const isValid = errors.length === 0;
      
      if (copyBtn) copyBtn.disabled = !isValid;
      if (downloadBtn) downloadBtn.disabled = !isValid;
    }

    function copyPresetJSON() {
      const errors = validateForm();
      if (errors.length > 0) {
        showToast(`‚ùå Please fix the following errors:\n${errors.join('\n')}`, "error");
        return;
      }
      const exportForPresets = document.getElementById('exportForPresetsJson').checked;
      const data = getPresetData();
      let json;
      if (exportForPresets) {
        if (!data.moduleCode) {
          showToast("‚ùå Module Code is required for presets.json export", "error");
          return;
        }
        if (!data.cohort) {
          showToast("‚ùå Cohort is required for presets.json export", "error");
          return;
        }
        // Create the nested structure for presets.json
        const presetStructure = {
          [data.moduleCode]: {
            [data.cohort]: {
              cohort: data.cohort === 'april' ? 'April' : 'September',
              moduleName: data.moduleName,
              moduleCode: data.moduleCode,
              year: data.year,
              moduleLeader: data.moduleLeader,
              firstTeachingDate: data.cohort === 'april' ? '2025-04-23' : '2025-09-23',
              moduleTutors: data.moduleTutors,
              weeks: data.weeks
            }
          }
        };
        json = JSON.stringify(presetStructure, null, 2);
      } else {
        // Export as single preset with cohort info
        const singlePreset = {
          ...data,
          cohort: data.cohort === 'april' ? 'April' : 'September',
          firstTeachingDate: data.cohort === 'april' ? '2025-04-23' : '2025-09-23'
        };
        json = JSON.stringify(singlePreset, null, 2);
      }
      navigator.clipboard.writeText(json).then(() => {
        showToast("‚úÖ Preset JSON copied to clipboard!", "success");
      }).catch(() => {
        showToast("‚ö†Ô∏è Failed to copy JSON", "error");
      });
    }

    function downloadPresetJSON() {
      const errors = validateForm();
      if (errors.length > 0) {
        showToast(`‚ùå Please fix the following errors:\n${errors.join('\n')}`, "error");
        return;
      }
      const exportForPresets = document.getElementById('exportForPresetsJson').checked;
      const data = getPresetData();
      let json;
      if (exportForPresets) {
        if (!data.moduleCode) {
          showToast("‚ùå Module Code is required for presets.json export", "error");
          return;
        }
        if (!data.cohort) {
          showToast("‚ùå Cohort is required for presets.json export", "error");
          return;
        }
        // Create the nested structure for presets.json
        const presetStructure = {
          [data.moduleCode]: {
            [data.cohort]: {
              cohort: data.cohort === 'april' ? 'April' : 'September',
              moduleName: data.moduleName,
              moduleCode: data.moduleCode,
              year: data.year,
              moduleLeader: data.moduleLeader,
              firstTeachingDate: data.cohort === 'april' ? '2025-04-23' : '2025-09-23',
              moduleTutors: data.moduleTutors,
              weeks: data.weeks
            }
          }
        };
        json = JSON.stringify(presetStructure, null, 2);
      } else {
        // Export as single preset with cohort info
        const singlePreset = {
          ...data,
          cohort: data.cohort === 'april' ? 'April' : 'September',
          firstTeachingDate: data.cohort === 'april' ? '2025-04-23' : '2025-09-23'
        };
        json = JSON.stringify(singlePreset, null, 2);
      }
      const blob = new Blob([json], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${data.moduleCode || "preset"}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
      

    function addTutor(name = '', campus = '') {
      const container = document.getElementById('tutorContainer');
      const row = document.createElement('div');
      row.className = 'form-row compact-tutor tutor-row';

      row.innerHTML = `
        <div><input type="text" name="tutorName" placeholder="Tutor Name" value="${name}" /></div>
        <div><select name="tutorCampus">
          <option value="">Select Campus</option>
          <option value="London" ${campus === 'London' ? 'selected' : ''}>London</option>
          <option value="Reading" ${campus === 'Reading' ? 'selected' : ''}>Reading</option>
        </select></div>
        <div><button type="button" onclick="removeTutor(this)" class="remove-btn">‚ùå</button></div>
      `;

      container.appendChild(row);
      
      // Add event listeners to new inputs for auto-save
      const newInputs = row.querySelectorAll('input, select');
      newInputs.forEach(input => {
        input.addEventListener('input', saveData);
        input.addEventListener('change', saveData);
      });
    }

    function removeTutor(button) {
      const container = document.getElementById('tutorContainer');
      const rows = container.querySelectorAll('.tutor-row');
      if (rows.length > 1) {
        button.closest('.tutor-row').remove();
      } else {
        showToast("At least one tutor row is required", "error");
      }
    }


    function updateWeekNumbers() {
      const weekRows = document.querySelectorAll('.week-row');
      weekRows.forEach((row, index) => {
        const weekNumberSpan = row.querySelector('.week-number');
        if (weekNumberSpan) {
          weekNumberSpan.textContent = (index + 1).toString();
        }
        
        // Update button visibility
        const upButton = row.querySelector('button[onclick="moveWeekUp(this)"]');
        const downButton = row.querySelector('button[onclick="moveWeekDown(this)"]');
        
        if (upButton) {
          upButton.style.visibility = index === 0 ? 'hidden' : 'visible';
        }
        if (downButton) {
          downButton.style.visibility = index === weekRows.length - 1 ? 'hidden' : 'visible';
        }
        
        // Update row highlighting based on type
        updateRowHighlight(row);
      });
    }

    function updateRowHighlight(row) {
      const typeSelect = row.querySelector('select[name="weekType"]');
      const type = typeSelect ? typeSelect.value : '';
      const highlightSelect = row.querySelector('select[name="highlight"]');
      const highlight = highlightSelect ? highlightSelect.value : 'no';

      // Auto-set highlight to "yes" when assessment is selected
      if (type === 'assessment' && highlight === 'no') {
        highlightSelect.value = 'yes';
      }

      // Remove all existing highlight classes
      row.classList.remove('row-teaching', 'row-reading', 'row-assessment', 'row-break', 'row-highlighted');

      // Add appropriate highlight class based on type
      if (type) {
        row.classList.add(`row-${type}`);
      }

      // Add darker background if highlight is yes
      if (highlightSelect.value === 'yes') {
        row.classList.add('row-highlighted');
      }
    }

    function addRow() {
      const tbody = document.getElementById("weekBody");
      const tr = createWeekRow();
      
      // Add event listeners to new inputs for auto-save BEFORE adding to DOM
      const newInputs = tr.querySelectorAll('input, select');
      newInputs.forEach(input => {
        input.addEventListener('input', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        input.addEventListener('change', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        
        // Add highlighting update for type selects
        if (input.name === 'weekType') {
          input.addEventListener('change', function() {
            updateRowHighlight(this.closest('.week-row'));
          });
        }
      });
      
      // Add row highlight listeners
      addRowHighlightListeners(tr);
      
      // Add the row to the DOM
      tbody.appendChild(tr);
      
      // Update week numbers first, then button states
      updateWeekNumbers();
      updateButtonStates();
    }

    function addMultipleWeeks() {
      const weeksInput = document.getElementById('weeksToAdd');
      const weeksToAdd = parseInt(weeksInput.value) || 1;
      
      // Validate input
      if (weeksToAdd < 1 || weeksToAdd > 25) {
        showToast('‚ùå Please enter a number between 1 and 25', 'error');
        return;
      }
      
      // Add the specified number of weeks
      for (let i = 0; i < weeksToAdd; i++) {
        addRow();
      }
      
      // Reset input to 1
      weeksInput.value = 1;
      
      // Show success message
      if (weeksToAdd === 1) {
        showToast('‚úÖ 1 week added', 'success');
      } else {
        showToast(`‚úÖ ${weeksToAdd} weeks added`, 'success');
      }
    }

    function removeWeekRow(button) {
      const weekRows = document.querySelectorAll('.week-row');
      if (weekRows.length > 1) {
        button.closest('.week-row').remove();
        updateWeekNumbers();
        updateButtonStates();
      } else {
        showToast("At least one week is required", "error");
      }
    }

    function removeRow(btn) {
      const row = btn.closest('.week-row');
      if (row) {
        const weekRows = document.querySelectorAll('.week-row');
        if (weekRows.length > 1) {
          row.remove();
          updateWeekNumbers();
          updateButtonStates();
        } else {
          showToast("At least one week is required", "error");
        }
      }
    }

    function moveWeekUp(btn) {
      const currentRow = btn.closest('.week-row');
      const tbody = document.getElementById('weekBody');
      const previousRow = currentRow.previousElementSibling;
      
      // Check if there's a previous row to swap with
      if (previousRow && previousRow.classList.contains('week-row')) {
        // Swap the rows
        tbody.insertBefore(currentRow, previousRow);
        updateWeekNumbers();
        updateButtonStates();
      }
    }

    function moveWeekDown(btn) {
      const currentRow = btn.closest('.week-row');
      const tbody = document.getElementById('weekBody');
      const nextRow = currentRow.nextElementSibling;
      
      // Check if there's a next row to swap with
      if (nextRow && nextRow.classList.contains('week-row')) {
        // Move the current row after the next row
        tbody.insertBefore(currentRow, nextRow.nextElementSibling);
        updateWeekNumbers();
        updateButtonStates();
      }
    }

    function createWeekRow() {
      const tr = document.createElement('tr');
      tr.className = 'week-row';
      tr.innerHTML = `
        <td><span class="week-number"></span></td>
        <td><select name="weekType" required>
            <option value="">Select Type</option>
            <option value="teaching" selected>Teaching</option>
            <option value="reading">Reading</option>
            <option value="assessment">Assessment</option>
            <option value="break">Break</option>
        </select></td>
        <td><select name="highlight">
            <option value="no">No</option>
            <option value="yes">Yes</option>
        </select></td>
        <td><input type="text" name="topic" required placeholder="Enter topic"></td>
        <td>
          <div class="action-buttons">
            <button type="button" onclick="moveWeekUp(this)" title="Move week up">‚¨ÜÔ∏è</button>
            <button type="button" onclick="moveWeekDown(this)" title="Move week down">‚¨áÔ∏è</button>
            <button type="button" onclick="removeRow(this)" title="Remove week">‚ùå</button>
          </div>
        </td>
      `;
      addRowHighlightListeners(tr);
      return tr;
    }

    // Utility to add highlight and type event listeners to a row
    function addRowHighlightListeners(row) {
      const typeSelect = row.querySelector('select[name="weekType"]');
      if (typeSelect) {
        typeSelect.addEventListener('change', function() {
          updateRowHighlight(row);
          updateButtonStates();
        });
      }
      const highlightSelect = row.querySelector('select[name="highlight"]');
      if (highlightSelect) {
        highlightSelect.addEventListener('change', function() {
          updateRowHighlight(row);
          updateButtonStates();
        });
      }
    }

    // - showToast
    function showToast(message, type = 'info') {
      const toast = document.getElementById("toast");

      toast.className = '';
      toast.classList.add('show', `toast-${type}`);
      toast.textContent = message;

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.style.display = "none";
          toast.className = '';
        }, 500);
      }, 3000);

      toast.style.display = "block";
    }

    function confirmReset() {
      document.getElementById('resetModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    function performReset() {
      // Reset module details
      document.querySelector('[name="moduleName"]').value = '';
      document.querySelector('[name="moduleCode"]').value = '';
      document.querySelector('[name="year"]').value = '';
      document.querySelector('[name="moduleLeader"]').value = '';
      document.querySelector('[name="cohort"]').value = '';

      // Reset tutors (keep only one empty row)
      clearTutors();

      // Reset weeks (keep only one empty row)
      clearWeeks();

      // Clear saved data from localStorage
      localStorage.removeItem('newPresetDraft');

      // Hide tutor and week sections since module details are now empty
      checkModuleDetails();

      closeModal();
      showToast("üîÑ All fields reset successfully!", "success");
    }

    function clearTutors() {
      const container = document.getElementById('tutorContainer');
      const rows = container.querySelectorAll('.tutor-row');
      rows.forEach((row, index) => {
        if (index > 0) { // Remove all but the first row
          row.remove();
        } else {
          // Clear the first row
          row.querySelector('[name="tutorName"]').value = '';
          row.querySelector('[name="tutorCampus"]').value = '';
        }
      });
    }

    function clearWeeks() {
      const tbody = document.getElementById('weekBody');
      tbody.innerHTML = '';
      // Add one empty row
      addRow();
      updateWeekNumbers();
    }

    // Persistence functions
    function saveData() {
      const data = {
        moduleName: document.querySelector('[name="moduleName"]').value,
        moduleCode: document.querySelector('[name="moduleCode"]').value,
        year: document.querySelector('[name="year"]').value,
        moduleLeader: document.querySelector('[name="moduleLeader"]').value,
        cohort: document.querySelector('[name="cohort"]').value,
        tutors: getTutorsData(),
        weeks: getWeeksData()
      };
      localStorage.setItem('newPresetDraft', JSON.stringify(data));
    }

    function loadSavedData() {
      const savedData = localStorage.getItem('newPresetDraft');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          
          // Load module details
          if (data.moduleName) document.querySelector('[name="moduleName"]').value = data.moduleName;
          if (data.moduleCode) document.querySelector('[name="moduleCode"]').value = data.moduleCode;
          if (data.year) document.querySelector('[name="year"]').value = data.year;
          if (data.moduleLeader) document.querySelector('[name="moduleLeader"]').value = data.moduleLeader;
          if (data.cohort) document.querySelector('[name="cohort"]').value = data.cohort;


          // Load tutors
          if (data.tutors && data.tutors.length > 0) {
            loadTutorsData(data.tutors);
          }

          // Load weeks
          loadWeeksData(data.weeks);

          showToast("üìù Draft restored from previous session", "info");
          
          // Update button states after loading data
          updateButtonStates();
          
          // Check module details and show/hide sections
          checkModuleDetails();
        } catch (error) {
          console.error('Error loading saved data:', error);
        }
      }
    }

    function loadTutorsData(tutors) {
      const container = document.getElementById('tutorContainer');
      // Remove all existing tutor rows
      const existingRows = container.querySelectorAll('.tutor-row');
      existingRows.forEach(row => row.remove());
      
      // Add tutor rows with saved data
      tutors.forEach((tutor, index) => {
        if (index === 0) {
          // First tutor - add without delete button
          const row = document.createElement('div');
          row.className = 'form-row compact-tutor tutor-row';
          row.innerHTML = `
            <div><input type="text" name="tutorName" placeholder="Tutor Name" value="${tutor.name}" /></div>
            <div><select name="tutorCampus">
              <option value="">Select Campus</option>
              <option value="London" ${tutor.campus === 'London' ? 'selected' : ''}>London</option>
              <option value="Reading" ${tutor.campus === 'Reading' ? 'selected' : ''}>Reading</option>
            </select></div>
            <div class="button-placeholder"></div>
          `;
          container.appendChild(row);
        } else {
          // Additional tutors - add with delete button
          addTutor(tutor.name, tutor.campus);
        }
      });
    }

    function loadWeeksData(weeks) {
      const tbody = document.getElementById('weekBody');
      // Remove all existing week rows
      tbody.innerHTML = '';
      
      // Add week rows with saved data
      if (weeks && weeks.length > 0) {
        weeks.forEach(week => {
          addWeekRow(week);
        });
      } else {
        // If no saved weeks, add one empty row
        addRow();
      }
    }

    function getTutorsData() {
      const tutorElements = document.querySelectorAll('.tutor-row');
      return Array.from(tutorElements).map(row => ({
        name: row.querySelector('[name="tutorName"]').value,
        campus: row.querySelector('[name="tutorCampus"]').value
      })).filter(tutor => tutor.name && tutor.campus);
    }

    function getWeeksData() {
      const weekElements = document.querySelectorAll('.week-row');
      return Array.from(weekElements).map((row, index) => ({
        week: (index + 1).toString(),
        type: row.querySelector('[name="weekType"]').value,
        highlight: row.querySelector('[name="highlight"]').value,
        date: '',
        location: 'Location TBC',
        topic: row.querySelector('[name="topic"]').value
      })).filter(week => week.type || week.topic); // Save any week with any data
    }

    function setupAutoSave() {
      // Auto-save on input changes
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        input.addEventListener('change', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        
        // Add highlighting update for type selects
        if (input.name === 'weekType') {
          input.addEventListener('change', function() {
            updateRowHighlight(this.closest('.week-row'));
          });
        }
      });

      // Auto-save when tutors or weeks are added/removed
      const observer = new MutationObserver(function() {
        saveData();
        updateButtonStates();
      });
      observer.observe(document.getElementById('tutorContainer'), { childList: true, subtree: true });
      observer.observe(document.getElementById('weekBody'), { childList: true, subtree: true });
    }

    function checkModuleDetails() {
      const moduleName = document.querySelector('[name="moduleName"]').value.trim();
      const moduleCode = document.querySelector('[name="moduleCode"]').value.trim();
      const year = document.querySelector('[name="year"]').value;
      const moduleLeader = document.querySelector('[name="moduleLeader"]').value.trim();
      const cohort = document.querySelector('[name="cohort"]').value;
      
      const isComplete = moduleName && moduleCode && year && moduleLeader && cohort;
      
      const tutorSection = document.getElementById('tutorSection');
      const weekSection = document.getElementById('weekSection');
      
      if (isComplete) {
        tutorSection.style.display = 'block';
        weekSection.style.display = 'block';
      } else {
        tutorSection.style.display = 'none';
        weekSection.style.display = 'none';
      }
    }



    function addWeekRow(weekData) {
      const tbody = document.getElementById('weekBody');
      const tr = document.createElement('tr');
      tr.className = 'week-row';
      tr.innerHTML = `
        <td><span class="week-number"></span></td>
        <td><select name="weekType" required>
            <option value="">Select Type</option>
            <option value="teaching" ${weekData.type === 'teaching' ? 'selected' : ''}>Teaching</option>
            <option value="reading" ${weekData.type === 'reading' ? 'selected' : ''}>Reading</option>
            <option value="assessment" ${weekData.type === 'assessment' ? 'selected' : ''}>Assessment</option>
            <option value="break" ${weekData.type === 'break' ? 'selected' : ''}>Break</option>
        </select></td>
        <td><select name="highlight">
            <option value="no" ${weekData.highlight !== 'yes' ? 'selected' : ''}>No</option>
            <option value="yes" ${weekData.highlight === 'yes' ? 'selected' : ''}>Yes</option>
        </select></td>
        <td><input type="text" name="topic" value="${weekData.topic || ''}" required placeholder="Enter topic"></td>
        <td>
          <div class="action-buttons">
            <button type="button" onclick="moveWeekUp(this)" title="Move week up">‚¨ÜÔ∏è</button>
            <button type="button" onclick="moveWeekDown(this)" title="Move week down">‚¨áÔ∏è</button>
            <button type="button" onclick="removeWeekRow(this)" title="Remove week">‚ùå</button>
          </div>
        </td>
      `;
      
      // Add event listeners to new inputs for auto-save BEFORE adding to DOM
      const newInputs = tr.querySelectorAll('input, select');
      newInputs.forEach(input => {
        input.addEventListener('input', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        input.addEventListener('change', function() {
          saveData();
          updateButtonStates();
          checkModuleDetails();
        });
        // Add highlighting update for type selects
        if (input.name === 'weekType') {
          input.addEventListener('change', function() {
            updateRowHighlight(this.closest('.week-row'));
          });
        }
      });
      
      // Add row highlight listeners
      addRowHighlightListeners(tr);
      
      // Add the row to the DOM
      tbody.appendChild(tr);
      
      // Update week numbers first, then button states
      updateWeekNumbers();
      updateButtonStates();
    }

    // Toggle advanced settings section
    function toggleAdvancedSettings() {
      const content = document.getElementById('advancedContent');
      const toggleIcon = document.querySelector('.advanced-toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
      } else {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
    }

    // Initialize advanced settings as collapsed
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.getElementById('advancedContent');
      const toggleIcon = document.querySelector('.advanced-toggle-icon');
      if (content && toggleIcon) {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
    });

  </script>

  <!-- Modal for Reset Confirmation -->
  <div id="resetModal" class="modal-overlay">
    <div class="modal-box">
      <h3>Are you sure?</h3>
      <p>This will clear all module details, tutors, and weeks. This action cannot be undone.</p>
      <div class="modal-actions">
        <button onclick="closeModal()" class="cancel-btn">Cancel</button>
        <button onclick="performReset()" class="confirm-btn">Yes, Reset</button>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast" style="display: none;"></div>
</body>
</html>

