<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Assessment Generator | MScSimEd</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../favicon/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
  <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../favicon/web-app-manifest-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="../favicon/web-app-manifest-512x512.png">
  <link rel="manifest" href="../favicon/site.webmanifest">
  <meta name="theme-color" content="#4a90e2">
  
  <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="../../auth.js"></script>
  <style>
    .first-teaching-date-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      cursor: pointer;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }

    .section-header:hover {
      background: var(--hover-bg);
    }

    .section-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.2rem;
    }

    .toggle-icon {
      color: var(--text-secondary);
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }

    .section-content {
      padding: 20px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    .section-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .first-teaching-date-section .form-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: end;
    }

    .first-teaching-date-section label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .first-teaching-date-section input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .first-teaching-date-section input[type="date"]:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    .calculate-dates-btn {
      background: var(--button-primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .calculate-dates-btn:hover {
      background: var(--button-primary-hover);
      transform: translateY(-1px);
    }

    .display-field {
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      color: var(--text-secondary);
      font-size: 1rem;
      min-height: 20px;
      display: flex;
      align-items: center;
    }

    @media (max-width: 768px) {
      .first-teaching-date-section .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .calculate-dates-btn {
        width: 100%;
      }
    }

    /* JSON Import Section Styles */
    .json-import-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px var(--shadow-color);
      overflow: hidden;
    }

    .import-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: var(--card-bg);
      color: var(--text-primary);
      border-bottom-color: var(--button-primary);
    }

    .tab-content {
      display: none;
      padding: 0 20px 20px;
    }

    .tab-content.active {
      display: block;
    }

    .json-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 12px;
    }

    .json-textarea:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    .text-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .import-btn, .clear-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .import-btn {
      background: var(--button-primary);
      color: white;
    }

    .import-btn:hover:not(:disabled) {
      background: var(--button-primary-hover);
      transform: translateY(-1px);
    }

    .import-btn:disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
    }

    .clear-btn {
      background: #dc3545;
      color: white;
    }

    .clear-btn:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-1px);
    }

    .clear-btn:disabled {
      background: var(--border-color);
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
    }

    .file-upload-area {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .file-select-btn {
      padding: 10px 16px;
      background: var(--button-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-select-btn:hover {
      background: var(--button-secondary-hover);
      transform: translateY(-1px);
    }

    .selected-file {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Cohort Modal Styles */
    .cohort-options {
      display: flex;
      gap: 16px;
      margin: 20px 0;
      justify-content: center;
    }

    .cohort-btn {
      padding: 16px 24px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 160px;
    }

    .cohort-btn:hover {
      background: var(--button-primary);
      color: white;
      border-color: var(--button-primary);
      transform: translateY(-2px);
    }

    .cohort-btn:active {
      transform: translateY(0);
    }

    .assessment-block {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .assessment-header {
      padding: 16px 20px;
      font-size: 1.1rem;
      font-weight: 500;
      color: #004080;
      background: #e6f0fa;
      border-bottom: 1px solid #ccc;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .assessment-content {
      padding: 18px 20px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .assessment-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
      overflow: hidden;
    }
    .assessment-content label {
      display: block;
      margin-bottom: 10px;
      color: #333;
      font-weight: 400;
    }
    .assessment-content input[type="text"],
    .assessment-content input[type="datetime-local"],
    .assessment-content input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #bbb;
      border-radius: 5px;
      font-size: 1rem;
      margin-top: 3px;
      margin-bottom: 8px;
      background: #f8fafc;
    }

  </style>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#moduleDetails" class="skip-link">Skip to main content</a>
  
  <!-- Navbar -->
  <nav class="main-navbar" role="navigation" aria-label="Main navigation">
    <div class="navbar-title">
        <a href="../../index.html" style="text-decoration: none; color: inherit;" aria-label="MScSimEd Home">
          <div class="title-main">
            <img src="../../images/logo.png" alt="MScSimEd Logo" style="width: 32px; height: 32px; object-fit: contain; margin-right: 8px; vertical-align: middle;">
            MScSimEd
          </div>
        </a>
      <span class="title-separator">|</span>
        <div class="title-subtitle">üéØ Generate</div>
    </div>
      <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle mobile menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    <div class="navbar-links">
      <div class="dropdown">
        <button class="dropdown-btn">üìÖ Timetable</button>
        <div class="dropdown-content">
          <a href="../../timetable/generate.html">üéØ Generate</a>
          <a href="../../timetable/new.html">üìÑ New Preset</a>
          <a href="../../timetable/edit.html">‚úèÔ∏è Edit Preset</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropdown-btn">üìÖ Assessments</button>
        <div class="dropdown-content">
          <a href="generate.html">üéØ Generate</a>
          <a href="new.html">üìÑ New Preset</a>
          <a href="edit.html">‚úèÔ∏è Edit Preset</a>
        </div>
      </div>
        <a href="../overview/new.html" class="navbar-link">üìò Module Overview</a>
        <a href="../team/generate.html" class="navbar-link">üë• Module Team</a>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
    </div>
  </nav>

  <!-- Preset Buttons -->
  <div class="preset-container" role="group" aria-label="Module presets">
    <button class="preset-btn" onclick="loadPreset('ED70011X')" aria-label="Load Foundations of Simulation Education preset">
      <strong>Foundations of Simulation Education</strong>
      <span class="module-code">ED70011X</span>
      <span class="year-tag year-1">Year 1</span>
    </button>
    <button class="preset-btn" onclick="loadPreset('ED70012X')" disabled aria-label="Simulation Delivery & Leadership preset (not available)">
      <strong>Simulation Delivery & Leadership</strong>
      <span class="module-code">ED70012X</span>
      <span class="year-tag year-1">Year 1</span>
    </button>
    <button class="preset-btn" onclick="loadPreset('ED70013X')" aria-label="Load Digital Technologies in Education preset">
      <strong>Digital Technologies in Education</strong>
      <span class="module-code">ED70013X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>
    <button class="preset-btn" onclick="loadPreset('ED70014X')" disabled aria-label="Current Issues & Policies in Simulation Education preset (not available)">
      <strong>Current Issues & Policies in Simulation Education</strong>
      <span class="module-code">ED70014X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>
    <button class="preset-btn" onclick="loadPreset('ED70015X')" disabled aria-label="Simulation in Innovative Practice preset (not available)">
      <strong>Simulation in Innovative Practice</strong>
      <span class="module-code">ED70015X</span>
      <span class="year-tag year-2">Year 2</span>
    </button>
    <button class="preset-btn" onclick="loadPreset('ED70016X')" disabled aria-label="Quality Improvement & Demonstrative Simulation preset (not available)">
      <strong>Quality Improvement & Demonstrative Simulation</strong>
      <span class="module-code">ED70016X</span>
      <span class="year-tag year-3">Year 3</span>
    </button>
  </div>

  <!-- JSON Import Section -->
  <div class="json-import-section">
    <div class="section-header" onclick="toggleJsonImport()">
      <h3>üìÑ Import Custom JSON</h3>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="section-content" id="jsonImportContent">
      <div class="import-tabs">
        <button class="tab-btn active" onclick="switchTab('paste')">üìã Paste JSON</button>
        <button class="tab-btn" onclick="switchTab('file')">üìÅ Upload File</button>
      </div>
      
      <div id="pasteTab" class="tab-content active">
        <textarea id="jsonTextarea" class="json-textarea" placeholder="Paste your JSON preset here..." oninput="updateTextButtons()"></textarea>
        <div class="text-buttons">
          <button id="importFromText" class="import-btn" onclick="importFromText()" disabled>üì• Import JSON</button>
          <button id="clearTextBtn" class="clear-btn" onclick="clearTextarea()" disabled>üóëÔ∏è Clear</button>
        </div>
      </div>
      
      <div id="fileTab" class="tab-content">
        <div class="file-upload-area">
          <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileSelect(event)" style="display: none;">
          <button class="file-select-btn" onclick="document.getElementById('jsonFileInput').click()">üìÅ Choose JSON File</button>
          <span id="selectedFileName" class="selected-file">No file selected</span>
        </div>
        <button id="importFromFile" class="import-btn" onclick="importFromFile()" disabled>üì• Import File</button>
      </div>
    </div>
  </div>

  <!-- Module Details Box -->
  <div id="moduleDetails" class="module-details">
    <h2 id="modName">Module Name</h2>
    <p><strong>Code:</strong> <span id="modCode">Not Defined</span></p>
    <p><strong>Year:</strong> <span id="modYear">Not Defined</span></p>
    <p><strong>Leader:</strong> <span id="modLeader">Not Defined</span></p>
    <p><strong>Cohort:</strong> <span id="modCohort">Not Defined</span></p>
    <p><strong>AI Use Standard:</strong> <span id="modAIUseStandard">Not Defined</span></p>
  </div>

  <!-- Collapsible Assessments Section (now above AI Use) -->
  <div id="assessmentBlocksContainer"></div>
    
  <!-- Preview Controls: Preview, Open Tab, Copy HTML -->
  <div class="sticky-footer" role="toolbar" aria-label="Assessment overview actions">
    <button id="previewBtn" onclick="previewTimetable()" aria-label="Preview assessment overview">üîç Preview</button>
    <button id="openTabBtn" onclick="openPreviewInNewTab()" aria-label="Open preview in new tab">üßæ New Tab</button>
    <button id="copyBtn" onclick="copyFullHTML()" aria-label="Copy assessment overview HTML">üìã Copy</button>
    <button class="reset-btn" id="resetBtn" onclick="confirmReset()" aria-label="Reset all changes">üîÑ Reset</button>
  </div>
  
  <!-- iFrame Preview -->
  <iframe id="previewFrame"></iframe>

  <!-- JavaScript -->
  <script>
    let sharedPresets = {};
    let selectedPresetKey = null;
    let selectedCohort = null;

    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // Initialize theme on page load
    initTheme();
    
    // Mobile menu functionality
    function toggleMobileMenu() {
      const hamburger = document.querySelector('.hamburger-menu');
      const navbarLinks = document.querySelector('.navbar-links');
      
      hamburger.classList.toggle('active');
      navbarLinks.classList.toggle('active');
    }
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
      const hamburger = document.querySelector('.hamburger-menu');
      const navbarLinks = document.querySelector('.navbar-links');
      
      if (!hamburger.contains(event.target) && !navbarLinks.contains(event.target)) {
        hamburger.classList.remove('active');
        navbarLinks.classList.remove('active');
      }
    });

    // Toggle first teaching date section
    function toggleFirstTeachingDate() {
      const content = document.getElementById('firstTeachingDateContent');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
        localStorage.setItem('firstTeachingDateCollapsed', 'false');
      } else {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
        localStorage.setItem('firstTeachingDateCollapsed', 'true');
      }
    }

    // Initialize first teaching date section state
    function initFirstTeachingDateState() {
      const content = document.getElementById('firstTeachingDateContent');
      const toggleIcon = document.querySelector('.toggle-icon');
      
      if (content && toggleIcon) {
        const isCollapsed = localStorage.getItem('firstTeachingDateCollapsed');
        
        // Default to collapsed on first load (when no state is saved)
        if (isCollapsed === null || isCollapsed === 'true') {
          content.classList.add('collapsed');
          toggleIcon.textContent = '‚ñ∂';
          toggleIcon.style.transform = 'rotate(-90deg)';
        } else {
          content.classList.remove('collapsed');
          toggleIcon.textContent = '‚ñº';
          toggleIcon.style.transform = 'rotate(0deg)';
        }
      }
    }

    // JSON Import Functions
    let selectedFile = null;

    function toggleJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggleIcon.textContent = '‚ñº';
        toggleIcon.style.transform = 'rotate(0deg)';
      } else {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
    }

    function openJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      content.classList.remove('collapsed');
      toggleIcon.textContent = '‚ñº';
      toggleIcon.style.transform = 'rotate(0deg)';
    }

    function closeJsonImport() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      
      content.classList.add('collapsed');
      toggleIcon.textContent = '‚ñ∂';
      toggleIcon.style.transform = 'rotate(-90deg)';
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function updateTextButtons() {
      const textarea = document.getElementById('jsonTextarea');
      const importBtn = document.getElementById('importFromText');
      const clearBtn = document.getElementById('clearTextBtn');
      
      const hasContent = textarea.value.trim().length > 0;
      
      importBtn.disabled = !hasContent;
      clearBtn.disabled = !hasContent;
      
      // Save JSON content to localStorage
      if (hasContent) {
        localStorage.setItem('manualJsonContent', textarea.value);
      } else {
        localStorage.removeItem('manualJsonContent');
      }
    }

    function clearTextarea() {
      document.getElementById('jsonTextarea').value = '';
      localStorage.removeItem('manualJsonContent');
      updateTextButtons();
      showToast('Text area cleared', 'success');
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        document.getElementById('importFromFile').disabled = false;
        document.getElementById('selectedFileName').textContent = file.name;
        showToast(`üìÅ File selected: ${file.name}`, 'success');
      }
    }

    function importFromText() {
      const textarea = document.getElementById('jsonTextarea');
      const jsonText = textarea.value.trim();
      
      if (!jsonText) {
        showToast('Please enter JSON text to import', 'error');
        return;
      }

      try {
        const presetData = JSON.parse(jsonText);
        loadCustomPreset(presetData);
        // Save the imported JSON as manual content so it persists on refresh
        localStorage.setItem('manualJsonContent', jsonText);
        // Close JSON import section after successful import
        closeJsonImport();
        showToast('‚úÖ JSON preset imported successfully!', 'success');
      } catch (error) {
        showToast('‚ùå Invalid JSON format: ' + error.message, 'error');
      }
    }

    function importFromFile() {
      if (!selectedFile) {
        showToast('Please select a file first', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const presetData = JSON.parse(e.target.result);
          loadCustomPreset(presetData);
          // Save the imported JSON as manual content so it persists on refresh
          localStorage.setItem('manualJsonContent', e.target.result);
          // Close JSON import section after successful import
          closeJsonImport();
          showToast('‚úÖ JSON file imported successfully!', 'success');
        } catch (error) {
          showToast('‚ùå Invalid JSON file: ' + error.message, 'error');
        }
      };
      reader.readAsText(selectedFile);
    }

    function loadCustomPreset(presetData) {
      // Handle both direct object and key-value pair formats
      let data = presetData;
      if (typeof presetData === 'object' && Object.keys(presetData).length === 1) {
        // If it's a key-value pair like {"ED70013X": {...}}, extract the value
        const key = Object.keys(presetData)[0];
        data = presetData[key];
      }

      // Store AI use lists in localStorage for output
      localStorage.setItem('aiUsePermitted', JSON.stringify(data.aiUsePermitted || []));
      localStorage.setItem('aiUseNotPermitted', JSON.stringify(data.aiUseNotPermitted || []));

      // Close JSON import section when loading custom preset
      closeJsonImport();

      // Load module details
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = data.moduleName || 'Module';
      document.getElementById("modCode").textContent = data.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = data.year || 'Not Defined';
      document.getElementById("modLeader").textContent = data.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = data.cohort ? (data.cohort.charAt(0).toUpperCase() + data.cohort.slice(1).toLowerCase()) : 'Not Defined';
      document.getElementById("modAIUseStandard").textContent = data.aiUseStandard || 'Not Defined';

      // Remove timetable/weeks logic
      // Clear and render only assessments
      renderAssessmentBlocks(data.assessments, data.aiUseStandard);

      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;
    }

    // Initialize JSON import section as collapsed
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.getElementById('jsonImportContent');
      const toggleIcon = document.querySelector('.json-import-section .toggle-icon');
      if (content && toggleIcon) {
        content.classList.add('collapsed');
        toggleIcon.textContent = '‚ñ∂';
        toggleIcon.style.transform = 'rotate(-90deg)';
      }
      // Fetch presets and only then restore last preset or set up UI
      fetch('../../presets/assessments.json')
        .then(res => res.json())
        .then(data => {
          sharedPresets = data;
          restoreLastPreset();
        })
        .catch(err => {
          console.error('Failed to load assessment presets:', err);
          showToast('‚ùå Failed to load assessment presets', 'error');
        });
    });

    // - loadPreset
    function loadPreset(presetKey) {
      console.log('Loading preset:', presetKey);
      const presetData = sharedPresets[presetKey];
      if (!presetData) {
        showToast(`‚ùå No preset found for "${presetKey}"`, "error");
        return;
      }
      selectedPresetKey = presetKey; // Always set this before modal or cohort selection
      // Check if this preset has multiple cohorts
      if ((presetData.april || presetData.April) && (presetData.september || presetData.September)) {
        const modal = document.getElementById('cohortModal');
        if (modal) modal.style.display = 'flex';
        return;
      }
      // If only one cohort exists, load it directly
      const cohort = presetData.april ? 'april' : presetData.september ? 'september' : presetData.April ? 'April' : presetData.September ? 'September' : null;
      if (cohort) {
        selectedCohort = cohort;
        loadPresetWithCohort(presetKey, cohort);
      } else {
        // Fallback to old format
        loadPresetLegacy(presetKey, presetData);
      }
    }

    // - loadPresetWithCohort
    function loadPresetWithCohort(presetKey, cohort) {
      console.log('Loading preset with cohort:', presetKey, cohort);
      const container = document.getElementById("assessmentBlocksContainer");
      container.innerHTML = "";

      const presetData = sharedPresets[presetKey][cohort];

      if (!presetData) {
        showToast(`‚ùå No ${cohort} cohort found for "${presetKey}"`, "error");
        return;
      }

      // Store AI use lists in localStorage for output
      localStorage.setItem('aiUsePermitted', JSON.stringify(presetData.aiUsePermitted || []));
      localStorage.setItem('aiUseNotPermitted', JSON.stringify(presetData.aiUseNotPermitted || []));

      // Save current preset and cohort to localStorage
      localStorage.setItem('currentPreset', presetKey);
      localStorage.setItem('currentCohort', cohort);
      localStorage.removeItem('manualJsonContent');
      console.log('Saved preset and cohort to localStorage:', presetKey, cohort);

      // Clear JSON textarea since we're loading a preset
      document.getElementById('jsonTextarea').value = '';
      updateTextButtons();

      // Close JSON import section when loading a preset
      closeJsonImport();

      // Update module details
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = presetData.moduleName || 'Module';
      document.getElementById("modCode").textContent = presetData.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = presetData.year || 'Not Defined';
      document.getElementById("modLeader").textContent = presetData.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = presetData.cohort ? (presetData.cohort.charAt(0).toUpperCase() + presetData.cohort.slice(1).toLowerCase()) : 'Not Defined';
      document.getElementById("modAIUseStandard").textContent = presetData.aiUseStandard || 'Not Defined';


      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;

      showToast(`‚úÖ ${presetKey} (${presetData.cohort} Cohort) loaded`, "success");

      // Add after loading preset or custom JSON:
      renderAssessmentBlocks(presetData.assessments, presetData.aiUseStandard);

      // Add renderAIUseSection to update the AI use permitted/not permitted lists
      // renderAIUseSection(presetData.aiUsePermitted, presetData.aiUseNotPermitted);
    }

    // - loadPresetLegacy (for backward compatibility)
    function loadPresetLegacy(presetKey, presetData) {
      console.log('Loading legacy preset:', presetKey);
      const container = document.getElementById("assessmentBlocksContainer");
      container.innerHTML = "";

      // Store AI use lists in localStorage for output
      localStorage.setItem('aiUsePermitted', JSON.stringify(presetData.aiUsePermitted || []));
      localStorage.setItem('aiUseNotPermitted', JSON.stringify(presetData.aiUseNotPermitted || []));

      // Save current preset to localStorage and clear manual JSON content
      localStorage.setItem('currentPreset', presetKey);
      localStorage.removeItem('currentCohort');
      localStorage.removeItem('manualJsonContent');
      console.log('Saved preset to localStorage:', presetKey);

      // Clear JSON textarea since we're loading a preset
      document.getElementById('jsonTextarea').value = '';
      updateTextButtons();

      // Close JSON import section when loading a preset
      closeJsonImport();

      // Update module details (if present)
      document.getElementById("moduleDetails").style.display = "block";
      document.getElementById("modName").textContent = presetData.moduleName || 'Module';
      document.getElementById("modCode").textContent = presetData.moduleCode || 'Not Defined';
      document.getElementById("modYear").textContent = presetData.year || 'Not Defined';
      document.getElementById("modLeader").textContent = presetData.moduleLeader || 'Not Defined';
      document.getElementById("modCohort").textContent = 'Not Defined';
      document.getElementById("modAIUseStandard").textContent = 'Not Defined';

      // Show first teaching date section and restore its state
      const firstTeachingDateSection = document.getElementById("firstTeachingDateSection");
      firstTeachingDateSection.style.display = "block";
      initFirstTeachingDateState();

      // Enable buttons
      document.getElementById("previewBtn").disabled = false;
      document.getElementById("openTabBtn").disabled = false;
      document.getElementById("copyBtn").disabled = false;
      document.getElementById("resetBtn").disabled = false;

      showToast(`‚úÖ ${presetKey} loaded`, "success");

      // Add after loading preset or custom JSON:
      renderAssessmentBlocks(presetData.assessments, presetData.aiUseStandard);

      // Add renderAIUseSection to update the AI use permitted/not permitted lists
      // renderAIUseSection(presetData.aiUsePermitted, presetData.aiUseNotPermitted);
    }

    // Remove any functions or code related to weeks
    // (addWeek, updateHeader for weeks, resetWeeks, week-blocks, timetableForm, etc.)
    // Only keep assessment-related logic and UI

    // - copyFullHTML
    function copyFullHTML() {
      const fullHTML = generateFullHTML();

      const temp = document.createElement('textarea');
      temp.value = fullHTML;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);

      showToast("üìã HTML copied to clipboard", "success");
    }

    // - generateFullHTML
    function generateFullHTML() {
      // Get current module and assessment data
      const moduleName = document.getElementById('modName').textContent;
      const moduleCode = document.getElementById('modCode').textContent;
      const moduleYear = document.getElementById('modYear').textContent;
      const moduleLeader = document.getElementById('modLeader').textContent;
      const moduleCohort = document.getElementById('modCohort').textContent;
      // Use current assessment data from DOM
      let assessments = getCurrentAssessmentsFromDOM();
      // Get AI use and info from the preset if available
      let aiUseStandard = 'GREEN';
      let aiUsePermitted = [];
      let aiUseNotPermitted = [];
      let aiUseDescriptions = (sharedPresets && sharedPresets.aiUseDescriptions) ? sharedPresets.aiUseDescriptions : {};
      if (sharedPresets && selectedPresetKey) {
        const preset = sharedPresets[selectedPresetKey];
        const cohort = selectedCohort || (preset.april ? 'april' : 'september');
        const data = (preset[cohort] || preset) || {};
        aiUseStandard = data.aiUseStandard || 'GREEN';
        aiUsePermitted = data.aiUsePermitted || [];
        aiUseNotPermitted = data.aiUseNotPermitted || [];
      }
      // Always use the arrays from localStorage if present
      let aiUsePermittedFromStorage = [];
      let aiUseNotPermittedFromStorage = [];
      try {
        aiUsePermittedFromStorage = JSON.parse(localStorage.getItem('aiUsePermitted')) || [];
        aiUseNotPermittedFromStorage = JSON.parse(localStorage.getItem('aiUseNotPermitted')) || [];
      } catch (e) {}

      // Build the assessment table rows from current DOM data
      const assessmentDetailsTable = assessments.map(a => {
        const aiUseValue = (a.aiUse || aiUseStandard).toLowerCase();
        let badgeClass = 'badge-green';
        if (aiUseValue === 'amber') badgeClass = 'badge-amber';
        else if (aiUseValue === 'red') badgeClass = 'badge-red';
        const aiUseLabel = (a.aiUse || aiUseStandard).charAt(0).toUpperCase() + (a.aiUse || aiUseStandard).slice(1).toLowerCase();
        // Show assessment number and type together
        const assessmentNumType = (a.assessmentNumber !== undefined ? a.assessmentNumber : '') + ': ' + (a.assessmentType || '');
        return `
        <tr>
          <td>${assessmentNumType}</td>
          <td><span class="${badgeClass}">${aiUseLabel}</span></td>
          <td>${a.wordCount || ''}</td>
          <td>${a.weighting || ''}</td>
          <td>${a.passMark || ''}</td>
          <td>${a.submissionDate ? formatDateTime(a.submissionDate) : ''}</td>
          <td>${a.submissionMethod || ''}</td>
          <td>${a.feedbackDate ? formatDate(a.feedbackDate) : ''}</td>
        </tr>
      `;
      }).join('');
      // Build the AI use lists as bulleted lists
      const aiPermittedList = (Array.isArray(aiUsePermittedFromStorage) && aiUsePermittedFromStorage.length)
        ? '<ul>' + aiUsePermittedFromStorage.map(item => `<li>${item}</li>`).join('') + '</ul>'
        : '';
      const aiNotPermittedList = (Array.isArray(aiUseNotPermittedFromStorage) && aiUseNotPermittedFromStorage.length)
        ? '<ul>' + aiUseNotPermittedFromStorage.map(item => `<li>${item}</li>`).join('') + '</ul>'
        : '';
      // Always show permitted and not permitted sections if they have data
      let permittedSection = '';
      let notPermittedSection = '';
      if (aiPermittedList) {
        permittedSection = `<h3>AI Use That Is Permitted</h3>\n${aiPermittedList}`;
      }
      if (aiNotPermittedList) {
        notPermittedSection = `<h3>AI Use That Is <u>Not</u> Permitted</h3>\n${aiNotPermittedList}`;
      }
      // Get the correct AI use description for the module
      const aiUseDesc = aiUseDescriptions[(aiUseStandard || 'GREEN').toUpperCase()] || '';

      // Conditionally build permitted and not permitted sections
      // let permittedSection = '';
      // let notPermittedSection = '';
      // const aiUseStandardUpper = (aiUseStandard || 'GREEN').toUpperCase();
      // if (aiPermittedList) {
      //   permittedSection = `<h3>AI Use That Is Permitted</h3>\n${aiPermittedList}`;
      // }
      // if (aiNotPermittedList) {
      //   notPermittedSection = `<h3>AI Use That Is <u>Not</u> Permitted</h3>\n${aiNotPermittedList}`;
      // }
      // For RED, do not show permitted or not permitted lists
      // if (aiUseStandardUpper === 'RED') {
      //   permittedSection = '';
      //   notPermittedSection = '';
      // }
      // Return the provided HTML template, filled in
      // Generate module leader email from name
      function makeLeaderEmail(name) {
        if (!name) return '';
        // Remove titles and extra spaces, lowercase, replace spaces with dots
        let email = name.trim().toLowerCase();
        email = email.replace(/^(dr\.|prof\.|mr\.|mrs\.|ms\.|miss)\s+/i, '');
        email = email.replace(/\s+/g, '.');
        email = email.replace(/[^a-z.]/g, ''); // Remove non-alpha except dot
        return email + '@uwl.ac.uk';
      }
      const moduleLeaderEmail = makeLeaderEmail(moduleLeader);
      return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Module Assessments</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; color: #333; }
    .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); padding: 30px; }
    h1, h2, h3 { color: #004080; margin-bottom: 10px; }
    h1 { font-size: 2rem; }
    h2 { margin-top: 40px; font-size: 1.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 30px; background: #fff; }
    th, td { padding: 12px 16px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #e6f0fa; font-weight: bold; }
    .badge-green { background-color: #28a745; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; }
    .badge-amber { background-color: #ffc107; color: #333; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; }
    .badge-red { background-color: #dc3545; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; }
    .ai-section, .info-section { background: #eef6ff; border-left: 6px solid #0073e6; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .ai-section ul, .info-section ul { padding-left: 20px; }
    .ai-section li, .info-section li { margin-bottom: 8px; }
    .important-note { background: #fffbe6; border-left: 6px solid #ffc107; padding: 16px; border-radius: 8px; margin-top: 20px; }
    a { color: #0073e6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    @media (max-width: 768px) { table, th, td { font-size: 0.9rem; } h1 { font-size: 1.6rem; } h2 { font-size: 1.2rem; } }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fa-solid fa-clipboard-check"></i> Module Assessments</h1>
    <h2>Summative Assessment Table</h2>
    <table>
      <thead>
        <tr>
          <th>Type of Assessment</th>
          <th>AI Use</th>
          <th>Word Count or Equivalent</th>
          <th>Weighting</th>
          <th>Pass Mark</th>
          <th>Submission Due Date & Time</th>
          <th>Method of Submission</th>
          <th>Date of Feedback</th>
        </tr>
      </thead>
      <tbody>
        ${assessmentDetailsTable}
      </tbody>
    </table>
    <h2>AI Use in Assessment</h2>
    <div class="ai-section">
      <p>${aiUseDesc}</p>
      ${permittedSection}
      ${notPermittedSection}
      <div class="important-note">
        <strong>Important Notes:</strong><br>
        Any AI-assisted preparation must be critically reviewed and adapted by you. Assessors will look for originality, contextual understanding, and your personal facilitation style. You are encouraged to reference or declare how you used AI tools in preparation.
      </div>
    </div>
    <h2>Assessment Information</h2>
    <div class="info-section">
      <p><strong>Academic misconduct and plagiarism:</strong><br>
        All assessments are subject to the University's <a href="https://www.uwl.ac.uk/about-us/policies-and-regulations" target="_blank" rel="noopener noreferrer">Academic Regulations and Policies</a>. Pay particular attention to the regulations on <a href="https://www.uwl.ac.uk/about-us/policies-and-regulations/academic-offences-regulations" target="_blank" rel="noopener noreferrer">Academic Offences</a> and the guidance on <a href="https://www.uwl.ac.uk/about-us/policies-and-regulations/academic-offences-regulations" target="_blank" rel="noopener noreferrer">Plagiarism</a>.
      </p>
      <p><strong>Guides:</strong><br>
      Before your assessments, consult the <a href="https://www.uwl.ac.uk/about-us/policies-and-regulations" target="_blank" rel="noopener noreferrer">Fit to Sit and Fit to Submit guidance</a> via Guides for Success.</p>
      <p><strong>My Marks:</strong><br>
      Your assessment grades in <strong>My Marks</strong> are provisional. All grades are reviewed by an Assessment Board and an External Examiner before being confirmed. Final grades will appear in <strong>My Registry</strong> once approved.</p>
      <p><strong>How to submit your assignment:</strong><br>
      For detailed guidance on submitting assessments online, visit the 
      <a href="https://www.uwl.ac.uk/current-students/online-learning-tools/submitting-feedback-grades-online-using-turnitin#:~:text=How%20you%20submit%20your%20work,(website%20assessments%20and%20portfolios)." target="_blank" rel="noopener noreferrer">Submission Guidance page</a>.
      </p>
      <p>If you have any questions or problems, please contact your <a href="mailto:${moduleLeaderEmail}">module leader</a>.</p>
    </div>
  </div>
</html>
      `;
    }

    // Helper functions for formatting
    function formatDateTime(dt) {
      if (!dt) return '';
      // Accept both ISO and local datetime-local values
      const d = new Date(dt);
      if (isNaN(d)) return dt;
      return d.toLocaleString('en-GB', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function formatDate(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      if (isNaN(d)) return dt;
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    // NEW: Extract current assessment data from DOM
    function getCurrentAssessmentsFromDOM() {
      const blocks = document.querySelectorAll('.assessment-block');
      return Array.from(blocks).map(block => {
        return {
          assessmentNumber: block.querySelector('[name="assessmentNumber"]')?.value || '',
          assessmentType: block.querySelector('[name="type"]')?.value || '',
          aiUse: block.querySelector('[name="aiUseForAssessment"]')?.value || '',
          wordCount: block.querySelector('[name="wordCount"]')?.value || '',
          weighting: block.querySelector('[name="weighting"]')?.value || '',
          passMark: block.querySelector('[name="passMark"]')?.value || '',
          submissionDate: block.querySelector('[name="submissionDate"]')?.value || '',
          submissionMethod: block.querySelector('[name="submissionMethod"]')?.value || '',
          feedbackDate: block.querySelector('[name="feedbackDate"]')?.value || ''
        };
      });
    }

    // Add this function to update the header color live
    function updateAssessmentHeaderColor(id) {
      const block = document.getElementById(id);
      if (!block) return;
      const select = block.querySelector('[name="aiUseForAssessment"]');
      const header = block.querySelector('.assessment-header');
      if (!select || !header) return;
      const aiUse = select.value.toLowerCase();
      let headerBg = '#e6f0fa';
      if (aiUse === 'green') headerBg = '#e6f9ed';
      else if (aiUse === 'amber') headerBg = '#fff8e1';
      else if (aiUse === 'red') headerBg = '#fdeaea';
      header.style.background = headerBg;
    }

    // - previewTimetable
    function previewTimetable() {
      const iframe = document.getElementById('previewFrame');
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      
      doc.open();
      doc.write(generateFullHTML());
      doc.close();
    }

    // - showToast
    function showToast(message, type = 'info') {
      const toast = document.getElementById("toast");

      toast.className = '';
      toast.classList.add('show', `toast-${type}`);
      toast.textContent = message;

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.style.display = "none";
          toast.className = '';
        }, 500);
      }, 3000);

      toast.style.display = "block";
    }

    // - openPreviewInNewTab
    function openPreviewInNewTab() {
      // Use the same HTML as generateFullHTML, reflecting current state
      const fullHTML = generateFullHTML();
      const blob = new Blob([fullHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      showToast("üßæ Opening preview in new tab...", "info");
    }

    // - confirmReset
    function confirmReset() {
      document.getElementById('resetModal').style.display = 'flex';
    }

    // - closeModal
    function closeModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    // - selectCohort
    function selectCohort(cohort) {
      if (selectedPresetKey) {
        loadPresetWithCohort(selectedPresetKey, cohort);
        closeCohortModal();
      }
    }

    // - closeCohortModal
    function closeCohortModal() {
      document.getElementById('cohortModal').style.display = 'none';
      // selectedPresetKey = null; // Do not clear this here
    }

    // - restoreLastPreset
    function restoreLastPreset() {
      const manualJsonContent = localStorage.getItem('manualJsonContent');
      
      // If there's manual JSON content, restore it and load the data
      if (manualJsonContent && manualJsonContent.trim().length > 0) {
        const textarea = document.getElementById('jsonTextarea');
        textarea.value = manualJsonContent;
        updateTextButtons();
        console.log('Restored manual JSON content from localStorage');
        
        // Automatically load the JSON data into the form
        try {
          const presetData = JSON.parse(manualJsonContent);
          loadCustomPreset(presetData);
          console.log('Automatically loaded JSON data on page refresh');
        } catch (error) {
          console.error('Failed to parse restored JSON:', error);
        }
        return;
      }
      
      // Otherwise, try to restore the last preset
      const lastPreset = localStorage.getItem('currentPreset');
      const lastCohort = localStorage.getItem('currentCohort');
      console.log('Restoring preset:', lastPreset, 'cohort:', lastCohort);
      
      if (lastPreset && sharedPresets[lastPreset]) {
        if (lastCohort && sharedPresets[lastPreset][lastCohort]) {
          // Restore specific cohort
          console.log('Loading preset with cohort:', lastPreset, lastCohort);
          loadPresetWithCohort(lastPreset, lastCohort);
        } else {
          // Try to load preset (will show cohort selection if needed)
        console.log('Loading preset:', lastPreset);
        loadPreset(lastPreset);
        }
      } else {
        console.log('No preset to restore or preset not found');
        // Open JSON import section when no data is available
        openJsonImport();
      }
    }
    // - performReset
    function performReset() {
      closeModal();
      showToast("üîÑ Assessment overview reset.", "success");

      // Clear localStorage
      localStorage.removeItem('currentPreset');
      localStorage.removeItem('currentCohort');
      localStorage.removeItem('manualJsonContent');
      localStorage.removeItem('assessmentBlocksData'); // Clear assessment blocks data
      localStorage.removeItem('aiUsePermitted'); // Clear AI use lists
      localStorage.removeItem('aiUseNotPermitted'); // Clear AI use lists

      // Hide module details
      document.getElementById("moduleDetails").style.display = "none";
      document.getElementById("previewFrame").style.display = "none";

      // Clear values
      document.getElementById("modName").textContent = "Module Name";
      document.getElementById("modCode").textContent = "Not Defined";
      document.getElementById("modYear").textContent = "Not Defined";
      document.getElementById("modLeader").textContent = "Not Defined";
      document.getElementById("modCohort").textContent = "Not Defined";
      document.getElementById("modAIUseStandard").textContent = "Not Defined";

      // Clear assessment blocks
      const ab = document.getElementById("assessmentBlocksContainer");
      if (ab) ab.innerHTML = "";

      // Clear AI use fields
      document.getElementById('aiPermittedEdit').value = '';
      document.getElementById('aiNotPermittedEdit').value = '';

      // Clear JSON textarea
      document.getElementById("jsonTextarea").value = "";
      updateTextButtons();

      // Open JSON import section after reset
      openJsonImport();

      const iframe = document.getElementById("previewFrame");
      if (iframe) iframe.srcdoc = "";
    }

    // --- BANK HOLIDAYS & WORKING DAYS LOGIC ---
    let englandBankHolidays = [];
    let bankHolidaysLoaded = false;

    // Fetch England bank holidays from gov.uk
    async function fetchBankHolidays() {
      try {
        const res = await fetch('https://www.gov.uk/bank-holidays.json');
        const data = await res.json();
        englandBankHolidays = (data['england-and-wales']?.events || []).map(e => e.date);
        bankHolidaysLoaded = true;
      } catch (e) {
        console.error('Failed to fetch bank holidays:', e);
        bankHolidaysLoaded = false;
      }
    }
    fetchBankHolidays();

    // Helper: add working days, skipping weekends and bank holidays
    function addWorkingDays(startDate, days) {
      let date = new Date(startDate);
      let added = 0;
      while (added < days) {
        date.setDate(date.getDate() + 1);
        const day = date.getDay();
        const iso = date.toISOString().slice(0, 10);
        if (day === 0 || day === 6) continue; // Sunday=0, Saturday=6
        if (englandBankHolidays.includes(iso)) continue;
        added++;
      }
      return date;
    }

    // Attach auto-calc logic to assessment blocks
    function attachFeedbackAutoCalc() {
      document.querySelectorAll('.assessment-block').forEach(block => {
        const submissionInput = block.querySelector('input[name="submissionDate"]');
        const feedbackInput = block.querySelector('input[name="feedbackDate"]');
        if (!submissionInput || !feedbackInput) return;
        // Track if user has manually edited feedback date
        let userEdited = false;
        // If already attached, skip
        if (submissionInput._autoCalcAttached) return;
        submissionInput._autoCalcAttached = true;
        // On submission date change, auto-calc feedback date
        submissionInput.addEventListener('change', async function() {
          if (!bankHolidaysLoaded) await fetchBankHolidays();
          if (!submissionInput.value) return;
          // Only auto-set if user hasn't edited feedback or if feedback is empty
          if (!userEdited || !feedbackInput.value) {
            const feedbackDate = addWorkingDays(submissionInput.value, 15);
            // Format as yyyy-MM-ddTHH:mm for datetime-local
            const pad = n => n.toString().padStart(2, '0');
            const y = feedbackDate.getFullYear();
            const m = pad(feedbackDate.getMonth() + 1);
            const d = pad(feedbackDate.getDate());
            const h = pad(feedbackDate.getHours());
            const min = pad(feedbackDate.getMinutes());
            feedbackInput.value = `${y}-${m}-${d}T${h}:${min}`;
            userEdited = false;
          }
        });
        // If user edits feedback date, set flag
        feedbackInput.addEventListener('input', function() {
          userEdited = true;
        });
      });
    }

    // Add after loading preset or custom JSON:
    function renderAssessmentBlocks(assessments, aiUseStandard) {
      // Try to load from localStorage if available
      let stored = localStorage.getItem('assessmentBlocksData');
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed) && parsed.length > 0) {
            assessments = parsed;
          }
        } catch (e) {}
      }
      const container = document.getElementById('assessmentBlocksContainer');
      if (!container) return;
      container.innerHTML = '';
      // Fallback: if no assessments, show one empty editable block
      if (!assessments || !Array.isArray(assessments) || assessments.length === 0) {
        assessments = [{
          assessmentNumber: '',
          assessmentType: '',
          assessmentDetails: '',
          aiUse: aiUseStandard || '',
          wordCount: '',
          weighting: '',
          passMark: '',
          submissionMethod: '',
          submissionDate: '',
          feedbackDate: ''
        }];
      }
      assessments.forEach((a, i) => {
        const assessmentNumber = a.assessmentNumber || (i + 1);
        const assessmentType = a.assessmentType || '';
        const assessmentDetails = a.assessmentDetails || '';
        const aiUse = (a.aiUse || aiUseStandard || '').toLowerCase();
        const wordCount = a.wordCount || '';
        const weighting = a.weighting || '';
        const passMark = a.passMark || '';
        const submissionMethod = a.submissionMethod || '';
        const submissionDate = a.submissionDate || '';
        const feedbackDate = a.feedbackDate || '';
        const id = `assessment-${assessmentNumber}`;

        // Color code header based on AI use
        let headerBg = '#e6f0fa';
        if (aiUse === 'green') headerBg = '#e6f9ed';
        else if (aiUse === 'amber') headerBg = '#fff8e1';
        else if (aiUse === 'red') headerBg = '#fdeaea';

        // Format due date for header
        let dueDateStr = '';
        if (submissionDate) {
          const d = new Date(submissionDate);
          if (!isNaN(d)) {
            dueDateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
          } else {
            dueDateStr = submissionDate;
          }
        }

        container.innerHTML += `
          <div class="assessment-block" id="${id}">
            <div class="assessment-header" onclick="this.nextElementSibling.classList.toggle('collapsed'); this.querySelector('.toggle-icon') ? this.querySelector('.toggle-icon').textContent = this.nextElementSibling.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº' : null;" style="background: ${headerBg};">
              <span class="assessment-title">${assessmentNumber}: ${assessmentType} ${assessmentDetails ? '[' + assessmentDetails + ']' : ''}${dueDateStr ? ' [' + dueDateStr + ' | ' + weighting + '] ' : ''}</span>
              <span class="assessment-summary">Click to edit</span>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="assessment-content">
              <div class="form-row">
                <div>
                  <label>Assessment Number</label>
                  <div class="display-field">${assessmentNumber}</div>
                  <input type="hidden" name="assessmentNumber" value="${assessmentNumber}">
                </div>
                <div>
                  <label>Assessment Type</label>
                  <div class="display-field">${assessmentType}</div>
                  <input type="hidden" name="type" value="${assessmentType}">
                </div>
                <div>
                  <label>AI Usage</label>
                  <select name="aiUseForAssessment">
                    <option value="">Select...</option>
                    <option value="green" ${aiUse === 'green' ? 'selected' : ''}>Green</option>
                    <option value="amber" ${aiUse === 'amber' ? 'selected' : ''}>Amber</option>
                    <option value="red" ${aiUse === 'red' ? 'selected' : ''}>Red</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Word Count or Equivalent</label>
                  <input type="text" name="wordCount" value="${wordCount}" required>
                </div>
                <div>
                  <label>Weighting</label>
                  <input type="text" name="weighting" value="${weighting}" required>
                </div>
                <div>
                  <label>Pass Mark</label>
                  <input type="text" name="passMark" value="${passMark}" required>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Submission Method</label>
                  <input type="text" name="submissionMethod" value="${submissionMethod}" required>
                </div>
                <div>
                  <label>Submission Date & Time</label>
                  <input type="datetime-local" name="submissionDate" value="${submissionDate}" required>
                </div>
                <div>
                  <label>Date of Feedback</label>
                  <input type="datetime-local" name="feedbackDate" value="${feedbackDate}" required>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      // Attach color update handler and set initial color for each block
      assessments.forEach((a, i) => {
        const assessmentNumber = a.assessmentNumber || (i + 1);
        const id = `assessment-${assessmentNumber}`;
        const block = document.getElementById(id);
        if (block) {
          const select = block.querySelector('[name="aiUseForAssessment"]');
          if (select) {
            select.addEventListener('change', function() { updateAssessmentHeaderColor(id); persistAssessmentBlocks(); });
            // Set initial color in case of rerender
            updateAssessmentHeaderColor(id);
          }
          // Persist on all input changes
          block.querySelectorAll('input,select').forEach(input => {
            input.addEventListener('change', persistAssessmentBlocks);
            input.addEventListener('input', persistAssessmentBlocks);
          });
        }
      });
      // Collapse all but the first by default
      container.querySelectorAll('.assessment-content').forEach((el, idx) => {
        if (idx > 0) el.classList.add('collapsed');
      });
      // Attach feedback auto-calc logic
      attachFeedbackAutoCalc();
    }

    // Persist assessment blocks to localStorage
    function persistAssessmentBlocks() {
      const blocks = document.querySelectorAll('.assessment-block');
      const data = Array.from(blocks).map(block => {
        return {
          assessmentNumber: block.querySelector('[name="assessmentNumber"]')?.value || '',
          assessmentType: block.querySelector('[name="type"]')?.value || '',
          aiUse: block.querySelector('[name="aiUseForAssessment"]')?.value || '',
          wordCount: block.querySelector('[name="wordCount"]')?.value || '',
          weighting: block.querySelector('[name="weighting"]')?.value || '',
          passMark: block.querySelector('[name="passMark"]')?.value || '',
          submissionMethod: block.querySelector('[name="submissionMethod"]')?.value || '',
          submissionDate: block.querySelector('[name="submissionDate"]')?.value || '',
          feedbackDate: block.querySelector('[name="feedbackDate"]')?.value || ''
        };
      });
      localStorage.setItem('assessmentBlocksData', JSON.stringify(data));
    }

  </script>

  <!-- Modal for Reset Confirmation -->
  <div id="resetModal" class="modal-overlay">
    <div class="modal-box">
      <h3>Are you sure?</h3>
      <p>This will remove all current assessments from the overview.</p>
      <div class="modal-actions">
        <button onclick="closeModal()" class="cancel-btn">Cancel</button>
        <button onclick="performReset()" class="confirm-btn">Yes, Reset</button>
      </div>
    </div>
  </div>

  <!-- Modal for Cohort Selection -->
  <div id="cohortModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <h3>Select Cohort</h3>
      <p>Choose which cohort you want to load:</p>
      <div class="cohort-options">
        <button onclick="selectCohort('april')" class="cohort-btn">üå± April Cohort</button>
        <button onclick="selectCohort('september')" class="cohort-btn">üçÇ September Cohort</button>
      </div>
      <div class="modal-actions">
        <button onclick="closeCohortModal()" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>


  <!-- Toast Notifications -->
  <div id="toast" style="display: none;"></div>

</body>
</html>